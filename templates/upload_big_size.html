{% extends "header.html" %}

{% block title %}Upload Files{% endblock %}

{% block content %}
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0">Upload Files More Than 10MB</h5>
    </div>
    <div class="card-body">
        <form id="uploadForm" action="/upload-big-size" method="POST" enctype="multipart/form-data">
            <div class="mb-3">
                <label for="flag" class="form-label">Select a Flag</label>
                <small class="text-danger">*Required</small> 
                <select name="flag" class="form-select" required>
                    <option value="" disabled selected>Select a flag</option>
                    {% for flag in flags %}
                    <option value="{{ flag }}">{{ flag }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="mb-3">
                <div class="d-flex flex-column">
                    <div class="d-flex align-items-center mb-1">
                        <label for="file" class="form-label me-2">Select Text File(s)</label>
                        <small class="text-danger">*Maksimal size file upload 200MB</small> 
                    </div>
                    <small class="text-danger">
                        <i class="fas fa-exclamation-triangle"></i> Pastikan file yang diupload memiliki <strong>NPWP</strong> atau <strong>Nomor Identitas</strong> yang sama. Jika tidak sama, sistem <u>tidak akan menyimpan</u> file tersebut.
                    </small>
                </div>
                <input type="file" name="file" class="form-control mt-2" accept=".txt" multiple required>
            </div>
            <div class="mb-3">
                <label for="nama_file" class="form-label">Nama File</label>
                <small class="text-danger">*Required</small> 
                <input type="text" id="nama_file" name="nama_file" class="form-control" required>
                <div id="filename-error" class="text-danger mt-1" style="display: none;">
                    <small><i class="fas fa-exclamation-triangle"></i> Nama file sudah ada, harap masukkan nama file yang lain</small>
                </div>
            </div>
            <button type="submit" id="submitBtn" class="btn btn-primary">Upload</button>    
        </form>
    </div>
</div>

<div class="card mt-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Data Upload</h5>
        <a href="{{ url_for('upload_big_size_file') }}" class="btn btn-info btn-sm">
            <i class="fas fa-sync-alt"></i> Refresh</a>
    </div>
    <div class="card-body">
        <div class="table-responsive" style="overflow-x: auto;">
            <table id="uploadTable" class="table table-bordered nowrap w-100">
                <thead>
                    <tr>
                        <th><input type="text" placeholder="Cari Nama File" class="form-control form-control-sm" /></th>
                        <th><input type="text" placeholder="Cari Periode" class="form-control form-control-sm" /></th>
                        <th><input type="text" placeholder="Cari Tanggal" class="form-control form-control-sm" /></th>
                        <th></th>
                        <th></th>
                    </tr>
                    <tr>
                        <th>Nama File Upload</th>
                        <th>Periode Data</th>
                        <th>Upload Date</th>
                        <th>Status</th>
                        <th>Download</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in data %}
                    {% set task_id = item.task_id %}
                    {% set task = task_progress.get(task_id) %}
                    {% if task is mapping %}
                    {% set progress = task.get('progress', 0) %}
                    {% else %}
                    {% set progress = 100 if not task_id or task_id == 'null' else 0 %}
                    {% endif %}

                    <!-- {% set progress = task_progress.get(task_id, 100 if not task_id else 0) %} -->
                    {% set task = task_progress.get(task_id) %}
                    {% if task is mapping %}
                    {% set status = task.get('status', 'processing') %}
                    {% else %}
                    {% set status = 'completed' if not task_id or task_id == 'null' else 'processing' %}
                    {% endif %}

                    <tr>
                        <td>{{ item.namaFileUpload }}</td>
                        <td>{{ item.periodeData }}</td>
                        <td class="text-nowrap">{{ item.uploadDate if item.uploadDate else 'N/A' }}</td>
                        <td>
                            <div class="progress" style="height: 18px;">
                                <div id="progress-bar-{{ task_id or 'static-' ~ loop.index }}"
                                     class="progress-bar progress-bar-striped {{ 'progress-bar-animated' if progress < 100 and status != 'error' else '' }} {{ 'bg-danger' if status == 'error' else '' }}"
                                     role="progressbar" style="width: {{ progress }}%;"
                                     aria-valuenow="{{ progress }}" aria-valuemin="0" aria-valuemax="100">
                                    {{ 'Error' if status == 'error' else (progress ~ '%') }}
                                </div>
                            </div>
                        </td>
                        <td>
                            {% if progress == 100 and status != 'error' %}
                                <div class="btn-group">
                                    <a href="{{ url_for('download_excel', periodeData=item.periodeData, username=item.username, namaFileUpload=item.namaFileUpload, uploadDate=item.uploadDate|string) }}"
                                       class="btn btn-outline-success btn-sm" title="Download Excel">Excel
                                        <i class="fas fa-file-excel"></i>
                                    </a>
                                    <a href="{{ url_for('download_upload_zip', periodeData=item.periodeData, username=item.username, namaFileUpload=item.namaFileUpload, uploadDate=item.uploadDate|string) }}"
                                       class="btn btn-outline-primary btn-sm" title="Download ZIP">ZIP
                                        <i class="fas fa-file-archive"></i>
                                    </a>
                                </div>
                            {% elif status == 'error' %}
                                <button id="download-btn-{{ task_id or 'static-' ~ loop.index }}" class="btn btn-danger btn-sm" disabled>
                                    <i class="fas fa-exclamation-triangle"></i> Error
                                </button>
                            {% else %}
                                <button id="download-btn-{{ task_id or 'static-' ~ loop.index }}" class="btn btn-secondary btn-sm" disabled>
                                    <i class="fas fa-spinner fa-spin"></i> Processing
                                </button>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Success Notification Modal -->
<div class="modal fade" id="successNotificationModal" tabindex="-1" aria-labelledby="successNotificationModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content border border-success">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="successNotificationModalLabel">
                    <i class="fas fa-check-circle"></i> Upload Berhasil
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p id="successNotificationMessage">File berhasil diupload dan diproses!</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-success" onclick="window.location.reload()">OK</button>
            </div>
        </div>
    </div>
</div>

<!-- Error Notification Modal -->
<div class="modal fade" id="errorNotificationModal" tabindex="-1" 
     aria-labelledby="errorNotificationModalLabel" aria-hidden="true" 
     data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog">
        <div class="modal-content border border-danger">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="errorNotificationModalLabel">
                    <i class="fas fa-exclamation-triangle"></i> Upload Gagal
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="errorNotificationMessage" class="text-danger"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" onclick="window.location.reload()">OK</button>
            </div>
        </div>
    </div>
</div>

<!-- Duplicate File Modal -->
<div class="modal fade" id="duplicateFileModal" tabindex="-1" aria-labelledby="duplicateFileModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title" id="duplicateFileModalLabel">
                    <i class="fas fa-exclamation-triangle"></i> Peringatan
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p><strong>Nama File sudah ada!</strong></p>
                <p>Harap masukkan nama file yang lain.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
            </div>
        </div>
    </div>
</div>

<!-- Validation Error Modal -->
<div class="modal fade" id="validationErrorModal" tabindex="-1" aria-labelledby="validationErrorModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-danger">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="validationErrorModalLabel">Error Validasi</h5>
      </div>
      <div class="modal-body" id="validationErrorModalBody">
        <!-- Pesan error akan dimasukkan di sini -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-danger" onclick="location.reload();">OK</button>
      </div>
    </div>
  </div>
</div>


{% if task_id %}
    <script>
        const taskId = "{{ task_id }}";
        console.log("Assigned taskId for polling:", taskId);
    </script>
{% else %}
    <script>console.log("No taskId assigned");</script>
{% endif %}

<script>
    // Global error tracking
    const errorList = {}; 
    const validationErrorList = {}; 

    // Get existing file names from the table for client-side check
    const existingFileNames = [
        {% for item in data %}
        "{{ item.namaFileUpload }}",
        {% endfor %}
    ];

    

    // Function to check if filename already exists
    function checkFilenameExists(filename) {
        return existingFileNames.includes(filename.trim());
    }

    // Function to show duplicate file alert
    function showDuplicateFileAlert() {
        const modal = new bootstrap.Modal(document.getElementById('duplicateFileModal'));
        modal.show();
    }

    // Real-time validation on input
    document.getElementById('nama_file').addEventListener('input', function() {
        const filename = this.value.trim();
        const errorDiv = document.getElementById('filename-error');
        const submitBtn = document.getElementById('submitBtn');
        
        if (filename && checkFilenameExists(filename)) {
            errorDiv.style.display = 'block';
            this.classList.add('is-invalid');
            submitBtn.disabled = true;
        } else {
            errorDiv.style.display = 'none';
            this.classList.remove('is-invalid');
            submitBtn.disabled = false;
        }
    });

    // Form submission validation
    document.getElementById('uploadForm').addEventListener('submit', function(e) {
        const filenameInput = document.getElementById('nama_file');
        const filename = filenameInput.value.trim();
        
        // Client-side check
        if (checkFilenameExists(filename)) {
            e.preventDefault();
            showDuplicateFileAlert();
            filenameInput.focus();
            return false;
        }
        
        // Server-side check via AJAX before actual form submission
        e.preventDefault();
        
        const submitBtn = document.getElementById('submitBtn');
        const originalText = submitBtn.textContent;
        
        // Show loading state
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Checking...';
        
        // Check with server
        fetch('/check-filename', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ 'nama_file': filename })
        })
        .then(response => response.json())
        .then(data => {
            if (data.exists) {
                showDuplicateFileAlert();
                filenameInput.focus();
                filenameInput.classList.add('is-invalid');
                document.getElementById('filename-error').style.display = 'block';
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            } else {
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';
                this.submit();
            }
        })
        .catch(error => {
            console.error('Error checking filename:', error);
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';
            this.submit();
        });
    });

    document.addEventListener("DOMContentLoaded", function () {
        // Get all task IDs (filter out null/empty values)
        const rawTaskIds = {{ data | map(attribute='task_id') | list | tojson }};
        const taskIds = rawTaskIds.filter(id => {
            // More strict filtering to prevent None/null values
            return id && 
                id !== null && 
                id !== "null" && 
                id !== "None" && 
                id !== "undefined" &&
                typeof id === 'string' && 
                id.toString().trim() !== "" &&
                id.toString().trim() !== "None" &&
                id.toString().trim() !== "null";
        });

        const completedTasks = new Set();
        let activeTaskCount = 0;

        const filteredTaskIds = taskIds.filter(taskId => {
            const bar = document.getElementById(`progress-bar-${taskId}`);
            if (!bar) return false;

            const progress = parseInt(bar.getAttribute("aria-valuenow") || "0");
            const isError = bar.classList.contains("bg-danger");

            // Kalau sudah 100% atau error, anggap sudah selesai (tidak perlu polling)
            if (progress >= 100 || isError) {
                completedTasks.add(taskId);
                return false; // exclude dari polling
            }
            return true; // keep untuk dipolling
        });
        
        const sessionTaskId = "{{ task_id }}";
        if (sessionTaskId &&
            sessionTaskId !== "None" &&
            sessionTaskId !== "null" &&
            sessionTaskId.trim() !== "" &&
            !taskIds.includes(sessionTaskId)) {
            
            taskIds.push(sessionTaskId);
            filteredTaskIds.push(sessionTaskId);  // ⬅️ Tambahkan ini juga
        }

        console.log("Valid Task IDs found:", taskIds);
        console.log("Raw Task IDs:", rawTaskIds);

        // Initialize DataTable
        var table = $('#uploadTable').DataTable({
            responsive: true,
            pageLength: 10,
            lengthMenu: [[10, 25, 50, 100, -1], [10, 25, 50, 100, "Semua"]],
            order: [[2, 'desc']],
            lengthChange: true,
            orderCellsTop: true,
            fixedHeader: true,
            language: {
                search: "Cari:",
                lengthMenu: "Tampilkan _MENU_ entri",
                paginate: {
                    first: "Awal", last: "Akhir", next: "→", previous: "←"
                },
                zeroRecords: "Tidak ada data ditemukan",
                info: "Menampilkan _START_ sampai _END_ dari _TOTAL_ data",
                infoEmpty: "Menampilkan 0 dari 0 data"
            },
            columnDefs: [
                { targets: [3, 4], orderable: false }
            ]
        });

        // Filter per kolom
        $('#uploadTable thead tr:eq(0) th').each(function (i) {
            $('input', this).on('keyup change', function () {
                if (table.column(i).search() !== this.value) {
                    table.column(i).search(this.value).draw();
                }
            });
        });

        // Count active tasks and track completed ones
        document.querySelectorAll('[id^="progress-bar-"]').forEach(bar => {
            const fullTaskId = bar.id.replace('progress-bar-', '');
            // Skip static progress bars (they don't need polling)
            if (fullTaskId.match(/^static-\d+$/)) {
                return;
            }
            
            const taskId = fullTaskId;
            const progress = parseInt(bar.getAttribute("aria-valuenow") || "0");
            const hasError = bar.classList.contains('bg-danger');
            
            // Only count valid task IDs
            if (taskId && taskId !== 'None' && taskId !== 'null' && taskId.trim() !== '') {
                if (progress === 100 || hasError) {
                    completedTasks.add(taskId);
                } else {
                    activeTaskCount++;
                }
            }
        });

        console.log(`Initial status: ${completedTasks.size} completed tasks, ${activeTaskCount} active tasks`);

        // Modal functions
        function showSuccessNotificationModal(message) {
            console.log("Showing success modal:", message);
            document.getElementById("successNotificationMessage").textContent = message;
            const modal = new bootstrap.Modal(document.getElementById('successNotificationModal'));
            modal.show();
        }

        function showErrorNotificationModal(message) {
            console.log("Showing error modal:", message);
            document.getElementById("errorNotificationMessage").textContent = message;
            const modal = new bootstrap.Modal(document.getElementById('errorNotificationModal'));
            modal.show();
        }

        function showValidationErrorModal(message) {
            console.log("Memanggil showValidationErrorModal dengan pesan:", message);  // <--- DEBUG
            const modalBody = document.getElementById("validationErrorModalBody");
            modalBody.innerText = message;
            const modal = new bootstrap.Modal(document.getElementById("validationErrorModal"));
            modal.show();
        }

        // Handle task completion
        function handleTaskCompletion(taskId, isError = false, errorMessage = "") {
            if (completedTasks.has(taskId)) return;
            completedTasks.add(taskId);

            if (sessionStorage.getItem(`popup_shown_${taskId}`)) return;
            sessionStorage.setItem(`popup_shown_${taskId}`, 'true');
            
            activeTaskCount = Math.max(0, activeTaskCount - 1);

            console.log(`Task ${taskId} ${isError ? 'failed' : 'completed'}. Active tasks remaining: ${activeTaskCount}`);

            if (isError) {
                const errorType = errorList[taskId]?.type || "general_error";
                if (errorType === "validation_error") {
                    showValidationErrorModal(errorMessage);
                } else {
                    showErrorNotificationModal(errorMessage);
                }
            } else {
                if (activeTaskCount > 0) {
                    showSuccessNotificationModal("File berhasil diupload! Masih ada proses upload lain yang sedang berjalan.");
                }
            }

            // Check if all tasks are completed
            if (activeTaskCount <= 0) {
                const totalErrors = Object.keys(errorList).length;
                const totalTasks = taskIds.length;

                setTimeout(() => {
                    if (totalErrors === totalTasks && totalTasks > 0) {
                        showErrorNotificationModal("Semua proses upload gagal. Periksa file yang diupload!");
                    } else if (totalErrors > 0) {
                        showErrorNotificationModal("Proses upload selesai, namun beberapa file mengalami error.");
                    } else if (!isError && totalTasks > 0) {
                        showSuccessNotificationModal("Semua file berhasil diupload dan diproses!");
                    }
                }, 500);
            }
        }

        // Handle task error UI updates
        function handleTaskError(taskId, errorMessage = "Error", errorType = "general_error") {
            const progressBar = document.getElementById(`progress-bar-${taskId}`);
            const downloadBtn = document.getElementById(`download-btn-${taskId}`);
            
            if (progressBar) {
                progressBar.classList.remove("progress-bar-animated");
                progressBar.classList.add("bg-danger");
                progressBar.style.width = "100%";
                progressBar.innerText = "Error";
                progressBar.setAttribute("aria-valuenow", "100");
            }
            
            if (downloadBtn) {
                downloadBtn.disabled = true;
                downloadBtn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Error';
                downloadBtn.classList.remove("btn-primary", "btn-secondary");
                downloadBtn.classList.add("btn-danger");
            }

            // Store error info
            errorList[taskId] = { message: errorMessage, type: errorType };
        }

        // Handle task success UI updates
        function handleTaskSuccess(taskId) {
            const progressBar = document.getElementById(`progress-bar-${taskId}`);
            const downloadBtn = document.getElementById(`download-btn-${taskId}`);
            
            if (progressBar) {
                progressBar.classList.remove("progress-bar-animated");
                progressBar.style.width = "100%";
                progressBar.innerText = "100%";
                progressBar.setAttribute("aria-valuenow", "100");
            }
            
            if (downloadBtn) {
                // Replace with actual download buttons
                const row = downloadBtn.closest('tr');
                const cells = row.querySelectorAll('td');
                const namaFile = cells[0].textContent.trim();
                const periode = cells[1].textContent.trim();
                const uploadDate = cells[2].textContent.trim();
                
                downloadBtn.outerHTML = `
                    <div class="btn-group">
                        <a href="/download-excel?periodeData=${encodeURIComponent(periode)}&namaFileUpload=${encodeURIComponent(namaFile)}&uploadDate=${encodeURIComponent(uploadDate)}"
                        class="btn btn-outline-success btn-sm" title="Download Excel">Excel
                            <i class="fas fa-file-excel"></i>
                        </a>
                        <a href="/download-upload-zip?periodeData=${encodeURIComponent(periode)}&namaFileUpload=${encodeURIComponent(namaFile)}&uploadDate=${encodeURIComponent(uploadDate)}"
                        class="btn btn-outline-primary btn-sm" title="Download ZIP">ZIP
                            <i class="fas fa-file-archive"></i>
                        </a>
                    </div>
                `;
            }
        }

        // Poll for task status updates
        if (taskIds.length > 0) {
            console.log(`Starting status polling for ${taskIds.length} valid tasks`);
            
            filteredTaskIds.forEach(taskId => {
                if (!taskId || 
                    taskId === 'None' || 
                    taskId === 'null' || 
                    taskId === 'undefined' ||
                    taskId.trim() === '' ||
                    completedTasks.has(taskId)) {
                    console.log(`Skipping invalid or completed task: ${taskId}`);
                    return;
                }

                const interval = setInterval(() => {
                    fetch(`/progress-status/${taskId}`)
                        .then(response => response.json())
                        .then(data => {
                            const progress = data.progress || 0;
                            const status = data.status || 'processing';

                            console.log(`Polling task ${taskId}:`, data);

                            const progressBar = document.getElementById(`progress-bar-${taskId}`);
                            if (progressBar) {
                                progressBar.style.width = `${progress}%`;
                                progressBar.setAttribute('aria-valuenow', progress);
                                progressBar.innerText = (status === 'error') ? 'Error' : `${progress}%`;
                                progressBar.classList.toggle('progress-bar-animated', progress < 100 && status !== 'error');
                                progressBar.classList.toggle('bg-danger', status === 'error');
                            }

                            if (status === 'completed') {
                                clearInterval(interval);
                                handleTaskSuccess(taskId);
                                handleTaskCompletion(taskId);
                            } else if (status === 'error') {
                                clearInterval(interval);
                                const errorMessage = data.message || 'Terjadi error saat memproses file';
                                const errorType = data.error_type || 'general_error';

                                console.log("Polling error terdeteksi:", errorType, errorMessage);
                                handleTaskError(taskId, errorMessage, errorType);
                                handleTaskCompletion(taskId, true, errorMessage);
                            }
                        })
                        .catch(err => {
                            console.error(`Polling error for task ${taskId}:`, err);
                            clearInterval(interval);
                            const errorMessage = "Gagal mengambil status task";
                            handleTaskError(taskId, errorMessage, "system_error");
                            handleTaskCompletion(taskId, true, errorMessage);
                            showErrorNotificationModal(errorMessage);
                        });
                }, 3000); // polling setiap 3 detik
            });

        } else {
            console.log("No valid tasks found, skipping status polling");
        }

        const hasValidUncompletedTasks = taskIds.some(id => {
            return id && 
                id !== 'None' && 
                id !== 'null' && 
                id !== 'undefined' &&
                id.trim() !== '' &&
                !completedTasks.has(id);
        });
        
    });
</script>
<script src="{{ url_for('static', filename='js/bootstrap.bundle.min.js') }}"></script>

{% endblock %}

