{% extends "header.html" %}

{% block title %}Upload Files{% endblock %}

{% block content %}
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0">Upload Files More Than 10MB</h5>
    </div>
    <div class="card-body">
        <form id="uploadForm" action="/upload-big-size" method="POST" enctype="multipart/form-data">
            <div class="mb-3">
                <label for="flag" class="form-label">Select a Flag</label>
                <small class="text-danger">*Required</small> 
                <select name="flag" class="form-select" required>
                    <option value="" disabled selected>Select a flag</option>
                    {% for flag in flags %}
                    <option value="{{ flag }}">{{ flag }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="mb-3">
                <div class="d-flex flex-column">
                    <div class="d-flex align-items-center mb-1">
                        <label for="file" class="form-label me-2">Select Text File(s)</label>
                        <small class="text-danger">*Maksimal size file upload 200MB</small> 
                    </div>
                    <small class="text-success">
                        <i class="fas fa-exclamation-triangle"></i> Pastikan file yang diupload memiliki <strong>NPWP</strong> atau <strong>Nomor Identitas</strong> yang sama. Jika tidak sama, sistem <u>tidak akan memproses</u> file tersebut.
                    </small>
                </div>
                <input type="file" name="file" class="form-control mt-2" accept=".txt" multiple required>
            </div>
            <div class="mb-3">
                <label for="nama_file" class="form-label">Nama File</label>
                <small class="text-danger">*Required</small> 
                <input type="text" id="nama_file" name="nama_file" class="form-control" required>
                <div id="filename-error" class="text-danger mt-1" style="display: none;">
                    <small><i class="fas fa-exclamation-triangle"></i> Nama file sudah ada, harap masukkan nama file yang lain</small>
                </div>
            </div>
            <button type="submit" id="submitBtn" class="btn btn-primary">Upload</button>    
        </form>
    </div>
</div>

<div class="card mt-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Data Upload</h5>
        <a href="{{ url_for('upload_big_size_file') }}" class="btn btn-info btn-sm">
            <i class="fas fa-sync-alt"></i> Refresh</a>
    </div>
    <div class="card-body">
        <div class="table-responsive" style="overflow-x: auto;">
            <table id="uploadTable" class="table table-bordered nowrap w-100">
                <thead>
                    <tr>
                        <th>Nama File Upload</th>
                        <th>Periode Data</th>
                        <th>Upload Date</th>
                        <th>Status</th>
                        <th>Download</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- {% for item in data %}
                    {% set task_id = item.task_id %}
                    {% set task = task_progress.get(task_id) %}
                    
                    {% if task is mapping %}
                        {% set progress = task.get('progress', 0) %}
                        {% set status = task.get('status', 'processing') %}
                    {% else %}
                        {% if task_id and task_id != 'null' %}
                            {% set progress = 0 %}
                            {% set status = 'processing' %}
                        {% else %}
                            {% set progress = 100 %}
                            {% set status = 'completed' %}
                        {% endif %}
                    {% endif %}

                    <tr>
                        <td>{{ item.namaFileUpload|string }}</td>
                        <td>{{ item.periodeData|string }}</td>
                        <td class="text-nowrap" data-order="{{ item.uploadDate_raw|string }}">
                            {% if item.uploadDate %}
                                {{ item.uploadDate|string }}
                            {% else %}
                                N/A
                            {% endif %}
                        </td>
                        <td>
                            <div class="progress" style="height: 18px;">
                                <div id="progress-bar-{{ task_id or 'static-' ~ loop.index }}"
                                     class="progress-bar progress-bar-striped {{ 'progress-bar-animated' if progress < 100 and status != 'error' else '' }} {{ 'bg-danger' if status == 'error' else '' }}"
                                     role="progressbar" style="width: {{ progress }}%;"
                                     aria-valuenow="{{ progress }}" aria-valuemin="0" aria-valuemax="100">
                                    {{ 'Error' if status == 'error' else (progress ~ '%') }}
                                </div>
                            </div>
                        </td>
                        <td>
                            {% if progress == 100 and status != 'error' %}
                                <div class="btn-group">
                                    <a href="{{ url_for('download_big_size', periodeData=item.periodeData, username=item.username, namaFileUpload=item.namaFileUpload, uploadDate=item.uploadDate|string) }}"
                                       class="btn btn-outline-success btn-sm" title="Download Excel">Excel
                                        <i class="fas fa-file-excel"></i>
                                    </a>
                                    <a href="{{ url_for('download_upload_zip', periodeData=item.periodeData, username=item.username, namaFileUpload=item.namaFileUpload, uploadDate=item.uploadDate|string) }}"
                                       class="btn btn-outline-primary btn-sm" title="Download ZIP">ZIP
                                        <i class="fas fa-file-archive"></i>
                                    </a>
                                </div>
                            {% elif status == 'error' %}
                                <button id="download-btn-{{ task_id or 'static-' ~ loop.index }}" class="btn btn-danger btn-sm" disabled>
                                    <i class="fas fa-exclamation-triangle"></i> Error
                                </button>
                            {% else %}
                                <button id="download-btn-{{ task_id or 'static-' ~ loop.index }}" class="btn btn-secondary btn-sm" disabled>
                                    <i class="fas fa-spinner fa-spin"></i> Processing
                                </button>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %} -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Base Modal -->
{% include "base_modal.html" with context %}

<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 9999">
    <div id="uploadToast" class="toast align-items-center text-white bg-info border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body">
                <i class="fas fa-spinner fa-spin me-2"></i> Upload sedang diproses...
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    </div>
</div>

{% if task_id %}
    <script>
        const taskId = "{{ task_id }}";
        console.log("Assigned taskId for polling:", taskId);
    </script>
{% else %}
    <script>console.log("No taskId assigned");</script>
{% endif %}

<script>
    // Global variables and functions
    const errorList = {}; 
    const validationErrorList = {}; 
    let taskMetadataCache = {};
    let dataTable = null;; // Global DataTable instance

    function ensureStringData(data) {
        if (data === null || data === undefined) {
            return '';
        }
        
        if (typeof data === 'object') {
            if (data instanceof Date) {
                try {
                    return data.toLocaleString('id-ID', {
                        day: '2-digit',
                        month: 'long',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                } catch (e) {
                    return data.toString();
                }
            }
            try {
                return JSON.stringify(data);
            } catch (e) {
                return String(data);
            }
        }
        
        return String(data);
    }

    // Global function declarations - MOVED OUTSIDE OF DOCUMENT READY
    function updateOrAddRowToTable(taskId, filename, currentDate, metadata = null) {
        if (!dataTable) {
            console.warn('DataTable not available, skipping row update');
            return;
        }

        try {
            const existingRow = document.getElementById(`progress-bar-${taskId}`);
            if (existingRow) {
                const row = existingRow.closest('tr');
                const cells = row.querySelectorAll('td');
                
                if (metadata && cells.length >= 3) {
                    cells[0].textContent = ensureStringData(metadata.namaFileUpload || filename || '');
                    cells[1].textContent = ensureStringData(metadata.periodeData || '-');
                    cells[2].textContent = ensureStringData(metadata.uploadDate || currentDate || '');
                }
                return;
            }

            // Create new row
            const displayName = ensureStringData(metadata?.namaFileUpload || filename);
            const displayPeriode = ensureStringData(metadata?.periodeData || '-');
            const displayDate = ensureStringData(metadata?.uploadDate || currentDate);
            const safeTaskId = String(taskId).replace(/[^a-zA-Z0-9-_]/g, '');

            const progressHtml = `
                <div class="progress" style="height: 18px;">
                    <div id="progress-bar-${safeTaskId}" 
                        class="progress-bar progress-bar-striped progress-bar-animated" 
                        role="progressbar" 
                        style="width: 0%;" 
                        aria-valuenow="0" 
                        aria-valuemin="0" 
                        aria-valuemax="100">
                        0%
                    </div>
                </div>
            `;

            const downloadHtml = `
                <button id="download-btn-${safeTaskId}" 
                        class="btn btn-secondary btn-sm" 
                        disabled>
                    <i class="fas fa-spinner fa-spin"></i> Processing
                </button>
            `;

            const rowData = [
                displayName,
                displayPeriode,
                displayDate,
                progressHtml,
                downloadHtml
            ];

            try {
                const newRow = dataTable.row.add(rowData);
                const rowNode = newRow.draw(false).node(); // PERBAIKAN: draw(false) untuk tidak reset pagination
                $(rowNode).prependTo(dataTable.table().body());
                
                console.log(`‚úÖ Row added for task: ${taskId}`);
            } catch (addError) {
                console.error('‚ùå Error adding row:', addError);
                addRowDirectly(displayName, displayPeriode, displayDate, safeTaskId);
            }
            
        } catch (error) {
            console.error('‚ùå Error in updateOrAddRowToTable:', error);
        }
    }

    function addRowDirectly(displayName, displayPeriode, displayDate, safeTaskId) {
        try {
            const tableBody = document.querySelector('#uploadTable tbody');
            const newRow = document.createElement('tr');
            
            newRow.innerHTML = `
                <td>${displayName}</td>
                <td>${displayPeriode}</td>
                <td>${displayDate}</td>
                <td>
                    <div class="progress" style="height: 18px;">
                        <div id="progress-bar-${safeTaskId}" 
                            class="progress-bar progress-bar-striped progress-bar-animated" 
                            role="progressbar" 
                            style="width: 0%;" 
                            aria-valuenow="0" 
                            aria-valuemin="0" 
                            aria-valuemax="100">
                            0%
                        </div>
                    </div>
                </td>
                <td>
                    <button id="download-btn-${safeTaskId}" 
                            class="btn btn-secondary btn-sm" 
                            disabled>
                        <i class="fas fa-spinner fa-spin"></i> Processing
                    </button>
                </td>
            `;
            
            tableBody.insertBefore(newRow, tableBody.firstChild);
            console.log(`‚úÖ Row added directly for task: ${safeTaskId}`);
            
        } catch (directError) {
            console.error('‚ùå Error adding row directly:', directError);
        }
    }

    function debugDataTableState() {
        console.log('=== DataTable Debug Info ===');
        console.log('Is DataTable:', $.fn.DataTable.isDataTable('#uploadTable'));
        console.log('Table element exists:', document.getElementById('uploadTable') !== null);
        
        if ($.fn.DataTable.isDataTable('#uploadTable')) {
            const table = $('#uploadTable').DataTable();
            console.log('Row count:', table.rows().count());
            console.log('Column count:', table.columns().count());
            
            // Check data types in each row
            table.rows().every(function(index) {
                const data = this.data();
                console.log(`Row ${index} data types:`, data.map((item, i) => `Col${i}: ${typeof item}`));
            });
        }
        console.log('==============================');
    }

    function removeTaskRow(taskId) {
        if (!dataTable) {
            console.warn('DataTable not available');
            return;
        }

        try {
            taskId = (taskId || "").trim();
            let progressBar = document.getElementById(`progress-bar-${taskId}`);

            if (progressBar) {
                const row = progressBar.closest('tr');
                if (row) {
                    dataTable.row(row).remove().draw(false); // PERBAIKAN: draw(false)
                    console.log(`‚úÖ Removed row for task: ${taskId}`);
                }
            } else if (taskMetadataCache[taskId]?.namaFileUpload) {
                const filename = taskMetadataCache[taskId].namaFileUpload.trim();
                dataTable.rows().every(function () {
                    if (String(this.data()[0]).trim() === filename) {
                        this.remove();
                    }
                });
                dataTable.draw(false);
                console.log(`‚úÖ Removed row via metadata for task: ${taskId}`);
            }

            delete taskMetadataCache[taskId];
        } catch (error) {
            console.error('‚ùå Error removing row:', error);
        }
    }

    function showToast(message, type = 'success') {
        const toastEl = document.getElementById('uploadToast');
        const toastBody = toastEl.querySelector('.toast-body');

        toastBody.innerHTML = message;

        // Change background according to notification type
        toastEl.classList.remove('bg-success', 'bg-danger', 'bg-warning', 'bg-info');

        if (type === 'error') {
            toastEl.classList.add('bg-danger');
            toastBody.innerHTML = '<i class="fas fa-times-circle me-2"></i>' + message;
        } else if (type === 'warning') {
            toastEl.classList.add('bg-warning');
            toastBody.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>' + message;
        } else if (type === 'info') {
            toastEl.classList.add('bg-info');
            toastBody.innerHTML = '<i class="fas fa-info-circle me-2"></i>' + message;
        } else {
            toastEl.classList.add('bg-success');
            toastBody.innerHTML = '<i class="fas fa-check-circle me-2"></i>' + message;
        }

        const toast = new bootstrap.Toast(toastEl, { delay: 5000 });
        toast.show();
    }

    // Modal functions
    function showSuccessNotificationModal(message) {
        console.log("Showing success toast:", message);
        showToast(message, 'success');
    }

    function showErrorNotificationModal(message) {
        console.log("Showing error toast:", message);
        showToast(message, 'error');
    }

    function showValidationErrorModal(message) {
        console.log("Showing warning toast (validation):", message);
        showToast(message, 'warning');
    }

    // Handle task error UI updates
    function handleTaskError(taskId, errorMessage = "Error", errorType = "general_error") {
        const progressBar = document.getElementById(`progress-bar-${taskId}`);
        const downloadBtn = document.getElementById(`download-btn-${taskId}`);
        
        if (progressBar) {
            progressBar.classList.remove("progress-bar-animated");
            progressBar.classList.add("bg-danger");
            progressBar.style.width = "100%";
            progressBar.innerText = "Error";
            progressBar.setAttribute("aria-valuenow", "100");
        }
        
        if (downloadBtn) {
            downloadBtn.disabled = true;
            downloadBtn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Error';
            downloadBtn.className = "btn btn-danger btn-sm";
        }

        errorList[taskId] = { message: errorMessage, type: errorType };
    }

    // Handle task success UI updates
    function handleTaskSuccess(taskId) {
        const progressBar = document.getElementById(`progress-bar-${taskId}`);
        const downloadBtn = document.getElementById(`download-btn-${taskId}`);
        
        if (progressBar) {
            progressBar.classList.remove("progress-bar-animated");
            progressBar.style.width = "100%";
            progressBar.innerText = "100%";
            progressBar.setAttribute("aria-valuenow", "100");
        }
        
        if (downloadBtn && taskMetadataCache[taskId]) {
            const meta = taskMetadataCache[taskId];
            const namaFile = encodeURIComponent(meta.namaFileUpload || '');
            const periode = encodeURIComponent(meta.periodeData || '');
            const uploadDate = encodeURIComponent(meta.uploadDate || '');
            const username = encodeURIComponent(meta.username || '');

            downloadBtn.outerHTML = `
                <div class="btn-group">
                    <a href="/download-big-size?periodeData=${periode}&username=${username}&namaFileUpload=${namaFile}&uploadDate=${uploadDate}"
                    class="btn btn-outline-success btn-sm" title="Download Excel">
                    Excel <i class="fas fa-file-excel"></i>
                    </a>
                    <a href="/download_upload?periodeData=${periode}&username=${username}&namaFileUpload=${namaFile}&uploadDate=${uploadDate}"
                    class="btn btn-outline-primary btn-sm" title="Download ZIP">
                    ZIP <i class="fas fa-file-archive"></i>
                    </a>
                </div>
            `;
            
            // Update row data
            const row = document.getElementById(`progress-bar-${taskId}`)?.closest('tr');
            if (row) {
                const cells = row.querySelectorAll('td');
                if (cells.length >= 2) {
                    cells[0].textContent = meta.namaFileUpload;
                    cells[1].textContent = meta.periodeData;
                }
            }
        }
    }

    // Get existing file names from the table for client-side check
    const existingFileNames = [
        {% for item in data %}
        "{{ item.namaFileUpload }}",
        {% endfor %}
    ];

    function showUploadStartedToast() {
        const toastEl = document.getElementById("uploadToast");
        const toast = new bootstrap.Toast(toastEl, { delay: 5000 });
        toast.show();
    }

    document.getElementById("uploadForm").addEventListener("submit", function (e) {
        showUploadStartedToast();
    });

    // Function to check if filename already exists
    function checkFilenameExists(filename) {
        return existingFileNames.includes(filename.trim());
    }

    // Function to show duplicate file alert
    function showDuplicateFileAlert() {
        const modal = new bootstrap.Modal(document.getElementById('duplicateFileModal'));
        modal.show();
    }

    // Real-time validation on input
    document.getElementById('nama_file').addEventListener('input', function() {
        const filename = this.value.trim();
        const errorDiv = document.getElementById('filename-error');
        const submitBtn = document.getElementById('submitBtn');
        
        if (filename && checkFilenameExists(filename)) {
            errorDiv.style.display = 'block';
            this.classList.add('is-invalid');
            submitBtn.disabled = true;
        } else {
            errorDiv.style.display = 'none';
            this.classList.remove('is-invalid');
            submitBtn.disabled = false;
        }
    });

    // Form submission validation
    document.getElementById('uploadForm').addEventListener('submit', function(e) {
        const filenameInput = document.getElementById('nama_file');
        const filename = filenameInput.value.trim();
        
        // Client-side check
        if (checkFilenameExists(filename)) {
            e.preventDefault();
            showDuplicateFileAlert();
            filenameInput.focus();
            return false;
        }
        
        // Server-side check via AJAX before actual form submission
        e.preventDefault();
        
        const submitBtn = document.getElementById('submitBtn');
        const originalText = submitBtn.textContent;
        
        // Show loading state
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Checking...';
        
        // Check with server
        fetch('/check-filename', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ 'nama_file': filename })
        })
        .then(response => response.json())
        .then(data => {
            if (data.exists) {
                showDuplicateFileAlert();
                filenameInput.focus();
                filenameInput.classList.add('is-invalid');
                document.getElementById('filename-error').style.display = 'block';
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            } else {
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';
                this.submit();
            }
        })
        .catch(error => {
            console.error('Error checking filename:', error);
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';
            showUploadStartedToast();
            this.submit();
        });
    });

    $(document).ready(function() {
        try {
            if ($.fn.DataTable.isDataTable('#uploadTable')) {
                $('#uploadTable').DataTable().destroy();
            }

            // PERBAIKAN: Assign ke global variable
            dataTable = $('#uploadTable').DataTable({
                processing: true,
                serverSide: true,
                ajax: {
                    url: '/api/upload-data',
                    type: 'GET',
                    error: function(xhr, error, code) {
                        console.error('‚ùå DataTable Ajax Error:', { xhr, error, code });
                    }
                },
                responsive: true,
                pageLength: 10,
                order: [[2, 'desc']],
                language: {
                    processing: "‚è≥ Sedang memuat data...",
                    search: "Cari:",
                    lengthMenu: "Tampilkan _MENU_ entri",
                    paginate: { first: "Awal", last: "Akhir", next: "‚Üí", previous: "‚Üê" },
                    zeroRecords: "Tidak ada data ditemukan",
                    info: "Menampilkan _START_ sampai _END_ dari _TOTAL_ data",
                    infoEmpty: "Menampilkan 0 dari 0 data",
                    infoFiltered: "(difilter dari _MAX_ total data)"
                },
                columns: [
                    { data: 0, title: "Nama File Upload", orderable: true },
                    { data: 1, title: "Periode Data", orderable: true },
                    { data: 2, title: "Upload Date", orderable: true, className: "text-nowrap" },
                    { data: 3, title: "Status", orderable: false, searchable: false },
                    { data: 4, title: "Download", orderable: false, searchable: false }
                ],
                drawCallback: function(settings) {
                    console.log('‚úÖ DataTable drawn');
                }
            });

            console.log('‚úÖ DataTable initialized');
            
            // Auto refresh every 30 seconds
            setInterval(function() {
                if (dataTable) {
                    dataTable.ajax.reload(null, false);
                }
            }, 3000000); // 30 minutes
            
        } catch (error) {
            console.error('‚ùå Failed to initialize DataTable:', error);
        }
    });

    document.addEventListener("DOMContentLoaded", function () {
        const completedTasks = new Set();
        let activeTaskCount = 0;

        // Get task IDs from backend (you need to pass this from your template)
        const rawTaskIds = typeof tasksFromBackend !== 'undefined' ? tasksFromBackend : [];
        const sessionTaskId = typeof taskId !== 'undefined' ? taskId : null;

        const validTaskIds = rawTaskIds.filter(id => 
            id && id !== 'None' && id !== 'null' && id.trim() !== ''
        );

        if (sessionTaskId && !validTaskIds.includes(sessionTaskId)) {
            validTaskIds.push(sessionTaskId);
        }

        console.log(`üìã Starting polling for ${validTaskIds.length} tasks`);

        validTaskIds.forEach(taskId => {
            const interval = setInterval(() => {
                fetch(`/progress-status/${taskId}`)
                    .then(response => response.json())
                    .then(data => {
                        console.log(`üìä Task ${taskId}:`, data);

                        // PERBAIKAN: Cache dan sanitasi metadata
                        if (data.metadata) {
                            const sanitized = {};
                            Object.keys(data.metadata).forEach(key => {
                                sanitized[key] = ensureStringData(data.metadata[key]);
                            });
                            taskMetadataCache[taskId] = sanitized;
                            
                            updateOrAddRowToTable(taskId, sanitized.namaFileUpload, 
                                                sanitized.uploadDate, sanitized);
                        }

                        // Update progress bar
                        const progressBar = document.getElementById(`progress-bar-${taskId}`);
                        if (progressBar) {
                            const progress = data.progress || 0;
                            const status = data.status || 'processing';
                            
                            progressBar.style.width = `${progress}%`;
                            progressBar.setAttribute('aria-valuenow', progress);
                            progressBar.innerText = status === 'error' ? 'Error' : `${progress}%`;
                            
                            progressBar.classList.toggle('progress-bar-animated', 
                                progress < 100 && status !== 'error');
                            progressBar.classList.toggle('bg-danger', status === 'error');
                        }

                        // Handle completion
                        if (data.completed && data.should_redirect) {
                            clearInterval(interval);
                            
                            if (data.error) {
                                const errorMsg = data.error_message || data.message || 'Error';
                                const errorType = data.error_type || 'general_error';
                                
                                if (errorType === 'validation_error') {
                                    removeTaskRow(taskId);
                                    showToast(errorMsg, 'warning');
                                } else {
                                    handleTaskError(taskId, errorMsg, errorType);
                                    showToast(errorMsg, 'error');
                                }
                            } else {
                                handleTaskSuccess(taskId);
                                showToast('File berhasil diproses!', 'success');
                            }
                        } else if (data.status === 'not_found') {
                            clearInterval(interval);
                            handleTaskError(taskId, 'Task tidak ditemukan', 'system_error');
                        }
                    })
                    .catch(err => {
                        console.error(`‚ùå Polling error for ${taskId}:`, err);
                        clearInterval(interval);
                        handleTaskError(taskId, 'Gagal mengambil status', 'system_error');
                    });
            }, 3000);
        });
    });
</script>
<script src="{{ url_for('static', filename='js/bootstrap.bundle.min.js') }}"></script>

{% endblock %}