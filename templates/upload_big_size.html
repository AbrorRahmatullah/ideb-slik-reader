{% extends "header.html" %}

{% block title %}Upload Files{% endblock %}

{% block content %}
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0">Upload Files More Than 10MB</h5>
    </div>
    <div class="card-body">
        <form id="uploadForm" action="/upload-big-size" method="POST" enctype="multipart/form-data">
            <div class="mb-3">
                <label for="flag" class="form-label">Select a Flag</label>
                <small class="text-danger">*Required</small> 
                <select name="flag" class="form-select" required>
                    <option value="" disabled selected>Select a flag</option>
                    {% for flag in flags %}
                    <option value="{{ flag }}">{{ flag }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="mb-3">
                <div class="d-flex flex-column">
                    <div class="d-flex align-items-center mb-1">
                        <label for="file" class="form-label me-2">Select Text File(s)</label>
                        <small class="text-danger">*Maksimal size file upload 200MB</small> 
                    </div>
                    <small class="text-success">
                        <i class="fas fa-exclamation-triangle"></i> Pastikan file yang diupload memiliki <strong>NPWP</strong> atau <strong>Nomor Identitas</strong> yang sama. Jika tidak sama, sistem <u>tidak akan memproses</u> file tersebut.
                    </small>
                </div>
                <input type="file" name="file" class="form-control mt-2" accept=".txt" multiple required>
            </div>
            <div class="mb-3">
                <label for="nama_file" class="form-label">Nama File</label>
                <small class="text-danger">*Required</small> 
                <input type="text" id="nama_file" name="nama_file" class="form-control" required>
                <div id="filename-error" class="text-danger mt-1" style="display: none;">
                    <small><i class="fas fa-exclamation-triangle"></i> Nama file sudah ada, harap masukkan nama file yang lain</small>
                </div>
            </div>
            <button type="submit" id="submitBtn" class="btn btn-primary">Upload</button>    
        </form>
    </div>
</div>

<div class="card mt-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Data Upload</h5>
        <a href="{{ url_for('upload_big_size_file') }}" class="btn btn-info btn-sm">
            <i class="fas fa-sync-alt"></i> Refresh</a>
    </div>
    <div class="card-body">
        <div class="table-responsive" style="overflow-x: auto;">
            <table id="uploadTable" class="table table-bordered nowrap w-100">
                <thead>
                    <tr>
                        <th>Nama File Upload</th>
                        <th>Periode Data</th>
                        <th>Upload Date</th>
                        <th>Status</th>
                        <th>Download</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Data will be loaded via AJAX -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Toast Notification -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 9999">
    <div id="uploadToast" class="toast align-items-center text-white bg-info border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body">
                <i class="fas fa-spinner fa-spin me-2"></i> Upload sedang diproses...
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    </div>
</div>

<!-- PERBAIKAN: Pass data dari backend ke JavaScript -->
<script>
    // Pass valid task IDs dari backend
    const tasksFromBackend = {{ tasksFromBackend | tojson | safe }};
    
    // Pass current task ID jika ada
    {% if task_id %}
    const taskId = "{{ task_id }}";
    {% else %}
    const taskId = null;
    {% endif %}
    
    console.log('üìã Tasks from backend:', tasksFromBackend);
    console.log('üéØ Current task ID:', taskId);
</script>

<script>
    // ==================== GLOBAL VARIABLES ====================
    const errorList = {}; 
    const validationErrorList = {}; 
    let taskMetadataCache = {};
    let dataTable = null;

    // ==================== UTILITY FUNCTIONS ====================
    
    function ensureStringData(data) {
        if (data === null || data === undefined) {
            return '';
        }
        
        if (typeof data === 'object') {
            if (data instanceof Date) {
                try {
                    return data.toLocaleString('id-ID', {
                        day: '2-digit',
                        month: 'long',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                } catch (e) {
                    return data.toString();
                }
            }
            try {
                return JSON.stringify(data);
            } catch (e) {
                return String(data);
            }
        }
        
        return String(data);
    }

    function showToast(message, type = 'success') {
        const toastEl = document.getElementById('uploadToast');
        const toastBody = toastEl.querySelector('.toast-body');

        toastBody.innerHTML = message;
        toastEl.classList.remove('bg-success', 'bg-danger', 'bg-warning', 'bg-info');

        if (type === 'error') {
            toastEl.classList.add('bg-danger');
            toastBody.innerHTML = '<i class="fas fa-times-circle me-2"></i>' + message;
        } else if (type === 'warning') {
            toastEl.classList.add('bg-warning');
            toastBody.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>' + message;
        } else if (type === 'info') {
            toastEl.classList.add('bg-info');
            toastBody.innerHTML = '<i class="fas fa-info-circle me-2"></i>' + message;
        } else {
            toastEl.classList.add('bg-success');
            toastBody.innerHTML = '<i class="fas fa-check-circle me-2"></i>' + message;
        }

        const toast = new bootstrap.Toast(toastEl, { delay: 5000 });
        toast.show();
    }

    // ==================== TABLE MANAGEMENT ====================
    
    function updateOrAddRowToTable(taskId, filename, currentDate, metadata = null, uploadSession = null) {
        if (!dataTable) {
            console.warn('DataTable not available, skipping row update');
            return;
        }

        try {
            // Generate unique progress bar ID dengan session
            const safeTaskId = String(taskId).replace(/[^a-zA-Z0-9-_]/g, '');
            const safeSession = uploadSession ? String(uploadSession).replace(/[^a-zA-Z0-9-_]/g, '') : 'legacy';
            const uniqueProgressBarId = `progress-bar-${safeTaskId}-${safeSession}`;
            
            // Check if row already exists
            let existingBar = document.getElementById(uniqueProgressBarId);
            
            if (existingBar) {
                // Update existing row
                const row = existingBar.closest('tr');
                const cells = row.querySelectorAll('td');
                
                if (metadata && cells.length >= 3) {
                    cells[0].textContent = ensureStringData(metadata.namaFileUpload || filename || '');
                    cells[1].textContent = ensureStringData(metadata.periodeData || '-');
                    cells[2].textContent = ensureStringData(metadata.uploadDate || currentDate || '');
                }
                return;
            }

            // Create new row
            const displayName = ensureStringData(metadata?.namaFileUpload || filename);
            const displayPeriode = ensureStringData(metadata?.periodeData || '-');
            const displayDate = ensureStringData(metadata?.uploadDate || currentDate);

            const progressHtml = `
                <div class="progress" style="height: 18px;">
                    <div id="${uniqueProgressBarId}" 
                        class="progress-bar progress-bar-striped progress-bar-animated" 
                        role="progressbar" 
                        style="width: 0%;" 
                        aria-valuenow="0" 
                        aria-valuemin="0" 
                        aria-valuemax="100"
                        data-task-id="${safeTaskId}"
                        data-upload-session="${safeSession}">
                        0%
                    </div>
                </div>
            `;

            const downloadHtml = `
                <button id="download-btn-${safeTaskId}" 
                        class="btn btn-secondary btn-sm" 
                        data-upload-session="${safeSession}"
                        disabled>
                    <i class="fas fa-spinner fa-spin"></i> Processing
                </button>
            `;

            const rowData = [
                displayName,
                displayPeriode,
                displayDate,
                progressHtml,
                downloadHtml
            ];

            try {
                // Tambahkan row ke DataTable
                const newRow = dataTable.row.add(rowData).draw(true);
                
                // Setelah row ditambahkan, render HTML dengan jQuery untuk cell status dan download
                const rowNode = newRow.node();
                const cells = $(rowNode).find('td');
                
                if (cells.length >= 5) {
                    // Render status/progress bar
                    $(cells[3]).html(progressHtml);
                    // Render download button
                    $(cells[4]).html(downloadHtml);
                }
                
                console.log(`‚úÖ Row added for task: ${taskId} with session: ${uploadSession}`);
            } catch (addError) {
                console.error('‚ùå Error adding row:', addError);
            }
            
        } catch (error) {
            console.error('‚ùå Error in updateOrAddRowToTable:', error);
        }
    }

    function removeTaskRow(taskId) {
        if (!dataTable) {
            console.warn('DataTable not available');
            return;
        }

        try {
            taskId = (taskId || "").trim();
            
            // Try to find progress bar with any session
            let progressBar = document.querySelector(`[data-task-id="${taskId}"]`);

            if (progressBar) {
                const row = progressBar.closest('tr');
                if (row) {
                    dataTable.row(row).remove().draw(false);
                    console.log(`‚úÖ Removed row for task: ${taskId}`);
                }
            } else if (taskMetadataCache[taskId]?.namaFileUpload) {
                const filename = taskMetadataCache[taskId].namaFileUpload.trim();
                dataTable.rows().every(function () {
                    if (String(this.data()[0]).trim() === filename) {
                        this.remove();
                    }
                });
                dataTable.draw(false);
                console.log(`‚úÖ Removed row via metadata for task: ${taskId}`);
            }

            delete taskMetadataCache[taskId];
        } catch (error) {
            console.error('‚ùå Error removing row:', error);
        }
    }

    // ==================== TASK STATUS HANDLERS ====================
    
    function handleTaskError(taskId, errorMessage = "Error", errorType = "general_error") {
        // Find progress bar dengan data-task-id attribute
        const progressBar = document.querySelector(`[data-task-id="${taskId}"]`);
        const downloadBtn = document.getElementById(`download-btn-${taskId}`);
        
        if (progressBar) {
            progressBar.classList.remove("progress-bar-animated");
            progressBar.classList.add("bg-danger");
            progressBar.style.width = "100%";
            progressBar.innerText = "Error";
            progressBar.setAttribute("aria-valuenow", "100");
        }
        
        if (downloadBtn) {
            downloadBtn.disabled = true;
            downloadBtn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Error';
            downloadBtn.className = "btn btn-danger btn-sm";
        }

        errorList[taskId] = { message: errorMessage, type: errorType };
    }

    function handleTaskSuccess(taskId) {
        const progressBar = document.querySelector(`[data-task-id="${taskId}"]`);
        const downloadBtn = document.getElementById(`download-btn-${taskId}`);
        
        if (progressBar) {
            progressBar.classList.remove("progress-bar-animated");
            progressBar.style.width = "100%";
            progressBar.innerText = "100%";
            progressBar.setAttribute("aria-valuenow", "100");
        }
        
        if (downloadBtn && taskMetadataCache[taskId]) {
            const meta = taskMetadataCache[taskId];
            const namaFile = encodeURIComponent(meta.namaFileUpload || '');
            const periode = encodeURIComponent(meta.periodeData || '');
            const uploadDate = encodeURIComponent(meta.uploadDate || '');
            const username = encodeURIComponent(meta.username || '');

            downloadBtn.outerHTML = `
                <div class="btn-group">
                    <a href="/download-big-size?periodeData=${periode}&username=${username}&namaFileUpload=${namaFile}&uploadDate=${uploadDate}"
                    class="btn btn-outline-success btn-sm" title="Download Excel">
                    Excel <i class="fas fa-file-excel"></i>
                    </a>
                    <a href="/download_upload?periodeData=${periode}&username=${username}&namaFileUpload=${namaFile}&uploadDate=${uploadDate}"
                    class="btn btn-outline-primary btn-sm" title="Download ZIP">
                    ZIP <i class="fas fa-file-archive"></i>
                    </a>
                </div>
            `;
        }
    }

    // ==================== FILENAME VALIDATION ====================
    
    const existingFileNames = []; // Will be populated from server

    function checkFilenameExists(filename) {
        return existingFileNames.includes(filename.trim());
    }

    // Real-time validation on input
    document.getElementById('nama_file').addEventListener('input', function() {
        const filename = this.value.trim();
        const errorDiv = document.getElementById('filename-error');
        const submitBtn = document.getElementById('submitBtn');
        
        if (filename && checkFilenameExists(filename)) {
            errorDiv.style.display = 'block';
            this.classList.add('is-invalid');
            submitBtn.disabled = true;
        } else {
            errorDiv.style.display = 'none';
            this.classList.remove('is-invalid');
            submitBtn.disabled = false;
        }
    });

    // Form submission validation - allow multiple uploads, reset button immediately after upload starts
    document.getElementById('uploadForm').addEventListener('submit', function(e) {
        const filenameInput = document.getElementById('nama_file');
        const filename = filenameInput.value.trim();
        e.preventDefault();
        const submitBtn = document.getElementById('submitBtn');
        const originalText = submitBtn.textContent;
        const form = this;

        // Show loading state for filename check only
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Checking...';

        // Check with server via AJAX
        fetch('/check-filename', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ 'nama_file': filename })
        })
        .then(response => response.json())
        .then(data => {
            if (data.exists) {
                showToast('Nama file sudah ada, harap masukkan nama file yang lain', 'warning');
                filenameInput.focus();
                filenameInput.classList.add('is-invalid');
                document.getElementById('filename-error').style.display = 'block';
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            } else {
                // Submit form ASYNCHRONOUSLY using FormData
                showToast('Upload dimulai...', 'info');
                const formData = new FormData(form);

                // Immediately reset button and allow new uploads
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;

                // Optionally reset form fields (except flag)
                // form.reset();

                // Send upload asynchronously
                fetch(form.action, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => {
                    console.log('üì§ Upload response status:', response.status);
                    console.log('üì§ Response content-type:', response.headers.get('content-type'));
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    return response.json();
                })
                .then(uploadData => {
                    console.log('üì• Upload response data:', uploadData);
                    
                    // If backend returns a task_id, add row and fire event to start polling
                    if (uploadData && uploadData.task_id) {
                        console.log('‚úÖ Task ID received:', uploadData.task_id);
                        
                        // Add row to DataTable immediately with progress bar at 0%
                        const now = new Date();
                        const currentDate = now.toLocaleString('id-ID', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                        
                        console.log('üìä Adding row to DataTable with:', {
                            taskId: uploadData.task_id,
                            filename: filename,
                            currentDate: currentDate,
                            uploadSession: uploadData.upload_session
                        });
                        
                        updateOrAddRowToTable(
                            uploadData.task_id,
                            filename,
                            currentDate,
                            { namaFileUpload: filename },
                            uploadData.upload_session || null
                        );
                        // Fire event to start polling
                        const event = new CustomEvent('taskStarted', { detail: { taskId: uploadData.task_id, uploadSession: uploadData.upload_session || null } });
                        document.dispatchEvent(event);
                    } else {
                        console.warn('‚ö†Ô∏è No task_id in response:', uploadData);
                    }
                    
                    // Show success or error
                    if (uploadData && uploadData.success) {
                        showToast('Upload berhasil dimulai', 'success');
                        document.getElementById('filename-error').style.display = 'none';
                        // Optionally reset form fields (except flag)
                        // form.reset();
                        // Reload DataTable agar data terbaru langsung muncul
                        if (window.dataTable && typeof window.dataTable.ajax === 'object' && typeof window.dataTable.ajax.reload === 'function') {
                            console.log('üîÑ Reloading DataTable');
                            window.dataTable.ajax.reload(null, false);
                        }
                    } else if (uploadData && uploadData.error) {
                        showToast(uploadData.error, 'error');
                    }
                })
                .catch(uploadError => {
                    showToast('Terjadi kesalahan saat upload', 'error');
                    console.error('Upload error:', uploadError);
                });
            }
        })
        .catch(error => {
            console.error('Error checking filename:', error);
            showToast('Terjadi kesalahan', 'error');
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
        });
    });

    // ==================== DATATABLE INITIALIZATION ====================
    
    $(document).ready(function() {
        try {
            if ($.fn.DataTable.isDataTable('#uploadTable')) {
                $('#uploadTable').DataTable().destroy();
            }

            dataTable = $('#uploadTable').DataTable({
                processing: true,
                serverSide: true,
                ajax: {
                    url: '/api/upload-data',
                    type: 'GET',
                    error: function(xhr, error, code) {
                        console.error('‚ùå DataTable Ajax Error:', { xhr, error, code });
                    }
                },
                responsive: true,
                pageLength: 10,
                order: [[2, 'desc']],
                language: {
                    processing: "‚è≥ Sedang memuat data...",
                    search: "Cari:",
                    lengthMenu: "Tampilkan _MENU_ entri",
                    paginate: { first: "Awal", last: "Akhir", next: "‚Üí", previous: "‚Üê" },
                    zeroRecords: "Tidak ada data ditemukan",
                    info: "Menampilkan _START_ sampai _END_ dari _TOTAL_ data",
                    infoEmpty: "Menampilkan 0 dari 0 data",
                    infoFiltered: "(difilter dari _MAX_ total data)"
                },
                columns: [
                    { data: 0, title: "Nama File Upload", orderable: true },
                    { data: 1, title: "Periode Data", orderable: true },
                    { data: 2, title: "Upload Date", orderable: true, className: "text-nowrap" },
                    { 
                        data: 3, 
                        title: "Status", 
                        orderable: false, 
                        searchable: false,
                        render: function(data, type, row) {
                            if (type === 'display') {
                                return data;
                            }
                            return data;
                        }
                    },
                    { 
                        data: 4, 
                        title: "Download", 
                        orderable: false, 
                        searchable: false,
                        render: function(data, type, row) {
                            if (type === 'display') {
                                return data;
                            }
                            return data;
                        }
                    }
                ],
                drawCallback: function(settings) {
                    console.log('‚úÖ DataTable drawn with', this.api().rows().count(), 'rows');
                }
            });

            console.log('‚úÖ DataTable initialized');
            
        } catch (error) {
            console.error('‚ùå Failed to initialize DataTable:', error);
        }
    });

    // ==================== TASK STARTED EVENT LISTENER ====================
    // NOTE: Variables must be defined outside DOMContentLoaded to be accessible here
    document.addEventListener('taskStarted', function(event) {
        const { taskId, uploadSession } = event.detail;
        console.log(`üéØ Task started event received - Task: ${taskId}, Session: ${uploadSession}`);
        
        // Add to validTaskIds if not already there
        if (typeof validTaskIds !== 'undefined' && !validTaskIds.includes(taskId)) {
            validTaskIds.push(taskId);
            console.log(`üìã Added task ${taskId} to valid tasks list`);
        }
        
        // Start polling for this new task - wait for DOMContentLoaded if needed
        if (typeof startAdaptivePolling === 'function') {
            console.log(`üöÄ Starting polling for newly uploaded task: ${taskId}`);
            startAdaptivePolling(taskId);
        } else {
            console.warn(`‚ö†Ô∏è Polling not yet initialized, will retry...`);
            setTimeout(() => {
                if (typeof startAdaptivePolling === 'function') {
                    console.log(`üöÄ Starting polling for newly uploaded task: ${taskId} (retry)`);
                    startAdaptivePolling(taskId);
                }
            }, 500);
        }
    });
    
    // ==================== PROGRESS POLLING SYSTEM ====================
    
    // Declare polling variables globally
    let completedTasks = new Set();
    let pollingIntervals = new Map();
    let taskUploadSessions = new Map();
    let taskStartTimes = new Map();
    let validTaskIds = [];
    let startAdaptivePolling = null; // Will be defined in DOMContentLoaded
    
    document.addEventListener("DOMContentLoaded", function () {
        // Initialize validTaskIds with data from backend
        validTaskIds = tasksFromBackend || [];
        if (taskId && !validTaskIds.includes(taskId)) {
            validTaskIds.push(taskId);
        }
        
        const POLLING_CONFIG = {
            fastInterval: 1000,
            slowInterval: 3000,
            maxStuckTime: 15000,
            progressThreshold: 5
        };

        console.log(`üìã Starting session-aware polling for ${validTaskIds.length} tasks`);

        // ========== SESSION VALIDATION ==========
        
        function isValidUploadSession(taskId, uploadSession, currentTaskId) {
            if (currentTaskId && taskId !== currentTaskId) {
                console.warn(`‚ö†Ô∏è Task ID mismatch: expected ${currentTaskId}, got ${taskId}`);
                return false;
            }
            
            const storedSession = taskUploadSessions.get(taskId);
            
            if (!storedSession) {
                taskUploadSessions.set(taskId, uploadSession);
                taskStartTimes.set(taskId, Date.now());
                console.log(`‚úÖ Registered upload session ${uploadSession} for task ${taskId}`);
                return true;
            }
            
            if (storedSession !== uploadSession) {
                console.warn(
                    `‚ö†Ô∏è Upload session mismatch for task ${taskId}: ` +
                    `stored=${storedSession}, received=${uploadSession}`
                );
                return false;
            }
            
            return true;
        }

        // ========== PROGRESS UPDATE ==========
        
        function updateProgressUI(taskId, data) {
            const uploadSession = data.upload_session;
            const returnedTaskId = data.task_id;
            if (!isValidUploadSession(returnedTaskId, uploadSession, taskId)) {
                console.warn(`üö´ Ignoring progress update for mismatched session`);
                return;
            }
            const safeTaskId = String(taskId).replace(/[^a-zA-Z0-9-_]/g, '');
            const safeSession = String(uploadSession || 'legacy').replace(/[^a-zA-Z0-9-_]/g, '');
            const progressBarId = `progress-bar-${safeTaskId}-${safeSession}`;
            let progressBar = document.getElementById(progressBarId);
            if (!progressBar) {
                progressBar = document.querySelector(`[data-task-id="${safeTaskId}"]`);
                if (progressBar && uploadSession) {
                    progressBar.id = progressBarId;
                    progressBar.setAttribute('data-upload-session', safeSession);
                }
            }
            if (!progressBar) {
                console.warn(`‚ö†Ô∏è Progress bar not found for task: ${taskId}`);
                return;
            }
            const progress = Math.min(Math.max(data.progress || 0, 0), 100);
            const status = data.status || 'processing';
            const message = data.message || '';
            progressBar.style.width = `${progress}%`;
            progressBar.setAttribute('aria-valuenow', progress);
            progressBar.setAttribute('data-upload-session', safeSession);
            progressBar.setAttribute('data-task-id', safeTaskId);
            if (message && progress < 100) {
                progressBar.innerText = `${progress}% - ${message}`;
            } else {
                progressBar.innerText = status === 'error' ? 'Error' : `${progress}%`;
            }
            const isAnimated = progress < 100 && status !== 'error';
            progressBar.classList.toggle('progress-bar-animated', isAnimated);
            progressBar.classList.toggle('progress-bar-striped', isAnimated);
            progressBar.classList.toggle('bg-danger', status === 'error');
            progressBar.classList.toggle('bg-success', status === 'completed' && progress === 100);
            const downloadBtn = document.getElementById(`download-btn-${safeTaskId}`);
            if (downloadBtn && progress < 100 && status !== 'error') {
                downloadBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ${progress}%`;
                downloadBtn.setAttribute('data-upload-session', safeSession);
            }
            // Tambahan: reload DataTable jika status completed/error
            if ((status === 'completed' || status === 'error') && window.dataTable && typeof window.dataTable.ajax === 'object' && typeof window.dataTable.ajax.reload === 'function') {
                setTimeout(function() {
                    window.dataTable.ajax.reload(null, false);
                }, 500);
            }
        }

        // ========== CLEANUP STALE BARS ==========
        
        function cleanupStaleProgressBars() {
            const currentTime = Date.now();
            const STALE_THRESHOLD = 300000; // 5 minutes
            
            document.querySelectorAll('[id^="progress-bar-"]').forEach(bar => {
                const barTaskId = bar.getAttribute('data-task-id');
                const barSession = bar.getAttribute('data-upload-session');
                
                if (!barTaskId) return;
                
                const isActive = validTaskIds.includes(barTaskId);
                const startTime = taskStartTimes.get(barTaskId);
                const currentSession = taskUploadSessions.get(barTaskId);
                
                if (!isActive || 
                    (currentSession && barSession && barSession !== currentSession) ||
                    (startTime && currentTime - startTime > STALE_THRESHOLD)) {
                    
                    console.log(`üßπ Removing stale progress bar: ${bar.id}`);
                    const row = bar.closest('tr');
                    if (row && dataTable) {
                        dataTable.row(row).remove().draw(false);
                    }
                }
            });
        }

        // ========== ADAPTIVE POLLING ==========
        
        startAdaptivePolling = function(taskId) {
            let currentInterval = POLLING_CONFIG.fastInterval;
            let consecutiveErrors = 0;
            const MAX_CONSECUTIVE_ERRORS = 5;
            
            function poll() {
                fetch(`/progress-status/${taskId}`, {
                    method: 'GET',
                    headers: {
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache'
                    }
                })
                .then(response => {
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    return response.json();
                })
                .then(data => {
                    consecutiveErrors = 0;
                    
                    const uploadSession = data.upload_session;
                    const returnedTaskId = data.task_id || taskId;
                    
                    console.log(
                        `üìä Task ${taskId} - Progress: ${data.progress}% - ` +
                        `Status: ${data.status} - Session: ${uploadSession}`
                    );

                    if (!isValidUploadSession(returnedTaskId, uploadSession, taskId)) {
                        console.warn(`üö´ Ignoring update from different upload session`);
                        if (pollingIntervals.has(taskId)) {
                            clearTimeout(pollingIntervals.get(taskId));
                            pollingIntervals.delete(taskId);
                        }
                        return;
                    }

                    if (data.metadata) {
                        const sanitized = {};
                        Object.keys(data.metadata).forEach(key => {
                            sanitized[key] = ensureStringData(data.metadata[key]);
                        });
                        taskMetadataCache[taskId] = sanitized;
                        
                        updateOrAddRowToTable(
                            taskId, 
                            sanitized.namaFileUpload,
                            sanitized.uploadDate, 
                            sanitized,
                            uploadSession
                        );
                    }

                    updateProgressUI(taskId, data);

                    if (data.completed && data.should_redirect) {
                        console.log(`‚úÖ Task ${taskId} completed with status: ${data.status}`);
                        
                        if (pollingIntervals.has(taskId)) {
                            clearTimeout(pollingIntervals.get(taskId));
                            pollingIntervals.delete(taskId);
                        }
                        
                        completedTasks.add(taskId);
                        taskUploadSessions.delete(taskId);
                        taskStartTimes.delete(taskId);
                        
                        if (data.error) {
                            const errorMsg = data.error_message || data.message || 'Error';
                            const errorType = data.error_type || 'general_error';
                            
                            if (errorType === 'validation_error') {
                                removeTaskRow(taskId);
                                showToast(errorMsg, 'warning');
                            } else {
                                handleTaskError(taskId, errorMsg, errorType);
                                showToast(errorMsg, 'error');
                            }
                        } else {
                            handleTaskSuccess(taskId);
                            showToast('File berhasil diproses!', 'success');
                            
                            if (dataTable) {
                                setTimeout(() => {
                                    dataTable.ajax.reload(null, false);
                                }, 2000);
                            }
                        }
                        return;
                    }
                    
                    if (data.status === 'not_found' || data.status === 'expired') {
                        console.warn(`‚ö†Ô∏è Task ${taskId} ${data.status}`);
                        if (pollingIntervals.has(taskId)) {
                            clearTimeout(pollingIntervals.get(taskId));
                            pollingIntervals.delete(taskId);
                        }
                        
                        if (data.status === 'not_found') {
                            handleTaskError(taskId, data.message || 'Task tidak ditemukan', 'system_error');
                        }
                        return;
                    }
                    
                    const timeoutId = setTimeout(poll, currentInterval);
                    pollingIntervals.set(taskId, timeoutId);
                })
                .catch(err => {
                    consecutiveErrors++;
                    console.error(`‚ùå Polling error for ${taskId} (${consecutiveErrors}/${MAX_CONSECUTIVE_ERRORS}):`, err);
                    
                    if (consecutiveErrors >= MAX_CONSECUTIVE_ERRORS) {
                        console.error(`‚ùå Too many errors for ${taskId}, stopping polling`);
                        if (pollingIntervals.has(taskId)) {
                            clearTimeout(pollingIntervals.get(taskId));
                            pollingIntervals.delete(taskId);
                        }
                        handleTaskError(taskId, 'Connection error', 'system_error');
                        return;
                    }
                    
                    const retryInterval = Math.min(currentInterval * 2, 10000);
                    const timeoutId = setTimeout(poll, retryInterval);
                    pollingIntervals.set(taskId, timeoutId);
                });
            }
            
            poll();
        };

        // ========== START POLLING ==========
        
        cleanupStaleProgressBars();

        validTaskIds.forEach(taskId => {
            if (!completedTasks.has(taskId)) {
                console.log(`üöÄ Starting session-aware polling for task: ${taskId}`);
                startAdaptivePolling(taskId);
            }
        });
        
        setInterval(cleanupStaleProgressBars, 60000);
        
        window.addEventListener('beforeunload', () => {
            pollingIntervals.forEach((timeoutId, taskId) => {
                clearTimeout(timeoutId);
                console.log(`üßπ Cleaned up polling for task: ${taskId}`);
            });
        });
    });
</script>

<script src="{{ url_for('static', filename='js/bootstrap.bundle.min.js') }}"></script>

{% endblock %}