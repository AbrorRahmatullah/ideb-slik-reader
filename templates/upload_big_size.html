{% extends "header.html" %}

{% block title %}Upload Files{% endblock %}

{% block content %}
<div class="card mb-4">
    <div class="card-header">
        <h5 class="mb-0">Upload Files More Than 10MB</h5>
    </div>
    <div class="card-body">
        <form id="uploadForm" action="/upload-big-size" method="POST" enctype="multipart/form-data">
            <div class="mb-3">
                <label for="flag" class="form-label">Select a Flag</label>
                <small class="text-danger">*Required</small> 
                <select name="flag" class="form-select" required>
                    <option value="" disabled selected>Select a flag</option>
                    {% for flag in flags %}
                    <option value="{{ flag }}">{{ flag }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="mb-3">
                <div class="d-flex align-items-center">
                    <label for="file" class="form-label me-2">Select JSON File(s)</label>
                    <small class="text-danger">*Maksimal size file upload 200MB</small> 
                </div>
                <input type="file" name="file" class="form-control" accept=".txt" multiple required>
            </div>
            <div class="mb-3">
                <label for="nama_file" class="form-label">Nama File</label>
                <small class="text-danger">*Required</small> 
                <input type="text" id="nama_file" name="nama_file" class="form-control" required>
                <div id="filename-error" class="text-danger mt-1" style="display: none;">
                    <small><i class="fas fa-exclamation-triangle"></i> Nama file sudah ada, harap masukkan nama file yang lain</small>
                </div>
            </div>
            <button type="submit" id="submitBtn" class="btn btn-primary">Upload</button>    
        </form>
    </div>
</div>

<div class="card" style="margin-top: 10px">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Data Upload</h5>
        <a href="{{ url_for('upload_big_size_file') }}" class="btn btn-info btn-sm">
            <i class="fas fa-sync-alt"></i> Refresh Data
        </a>
    </div>
    <div class="card-body">
        <!-- Filter Form -->
        <div class="filter-section mb-4">
            <form action="{{ url_for('upload_big_size_file') }}" method="get" class="row g-3">
                <div class="col-md-3">
                    <label for="periodeData" class="form-label">Periode Data:</label>
                    <select name="periodeData" id="periodeData" class="form-select">
                        <option value="">All</option>
                        {% for option in filter_options.periodeData %}
                        <option value="{{ option }}" {% if selected_filters.periodeData == option %}selected{% endif %}>{{ option }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="col-md-3">
                    <label for="username" class="form-label">Username:</label>
                    <select name="username" id="username" class="form-select">
                        <option value="">All</option>
                        {% for option in filter_options.username %}
                        <option value="{{ option }}" {% if selected_filters.username == option %}selected{% endif %}>{{ option }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="col-md-3">
                    <label for="namaFileUpload" class="form-label">Nama File Upload:</label>
                    <select name="namaFileUpload" id="namaFileUpload" class="form-select">
                        <option value="">All</option>
                        {% for option in filter_options.namaFileUpload %}
                        <option value="{{ option }}" {% if selected_filters.namaFileUpload == option %}selected{% endif %}>{{ option }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="col-md-3 d-flex align-items-center">
                    <button type="submit" class="btn btn-primary">Filter</button>
                    
                </div>
            </form>
        </div>
        
        <!-- Data Table -->
        <div class="table-responsive">
            <table class="table table-striped table-bordered">
                <thead class="table-dark">
                    <tr>
                        <th class="text-center">Nama File Upload</th>
                        <th class="text-center">Periode Data</th>
                        <th class="text-center">Upload Date</th>
                        <th class="text-center">Status</th>
                        <th class="text-center">Download</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in data %}
                    {% set task_id = item.task_id %}
                    {% set progress = task_progress.get(task_id, 100 if not task_id else 0) %}
                    <tr>
                        <td>{{ item.namaFileUpload }}</td>
                        <td>{{ item.periodeData }}</td>
                        <td>{% if item.uploadDate %}
                                {% set clean_date = item.uploadDate|string|replace('T', ' ')|replace('.823000', '')|replace('.000000', '')|replace('.123000', '')|replace('.456000', '')|replace('.789000', '') %}
                                {% if clean_date|length > 19 %}
                                    {{ clean_date[:19] }}
                                {% else %}
                                    {{ clean_date }}
                                {% endif %}
                            {% else %}
                                N/A
                            {% endif %}</td>
                        <td>
                            <div class="progress" style="height: 20px;">
                                <div id="progress-bar-{{ task_id or 'static-' ~ loop.index }}" class="progress-bar progress-bar-striped {{ 'progress-bar-animated' if progress < 100 else '' }}"
                                    role="progressbar"
                                    style="width: {{ progress }}%;"
                                    aria-valuenow="{{ progress }}" aria-valuemin="0" aria-valuemax="100">
                                    {{ progress }}%
                                </div>
                            </div>
                        </td>
                        <td class="text-center">
                            {% if progress == 100 %}
                                <div class="btn-group" role="group" aria-label="Download options">
                                    <!-- Tombol Download Excel -->
                                    <a href="{{ url_for('download_excel', periodeData=item.periodeData, username=item.username, namaFileUpload=item.namaFileUpload, uploadDate=item.uploadDate|string) }}"
                                        class="btn btn-outline-success btn-sm d-flex align-items-center gap-1 px-3 py-2"
                                        id="download-btn-{{ task_id or 'static-' ~ loop.index }}"
                                        title="Download Excel">
                                        <i class="fas fa-file-excel fa-fw"></i> <span>Output Excel</span>
                                    </a>

                                    <!-- Tombol Download ZIP -->
                                    <a href="{{ url_for('download_upload_zip', periodeData=item.periodeData, username=item.username, namaFileUpload=item.namaFileUpload, uploadDate=item.uploadDate|string) }}"
                                        class="btn btn-outline-primary btn-sm d-flex align-items-center gap-1 px-3 py-2"
                                        id="download-zip-btn-{{ task_id or 'static-' ~ loop.index }}"
                                        title="Download All Files as ZIP">
                                        <i class="fas fa-file-archive fa-fw"></i> <span>File Upload TXT</span>
                                    </a>
                                </div>
                            {% else %}
                                <button class="btn btn-secondary btn-sm" disabled id="download-btn-{{ task_id or 'static-' ~ loop.index }}"
                                       data-periode-data="{{ item.periodeData }}"
                                       data-username="{{ item.username }}"
                                       data-nama-file="{{ item.namaFileUpload }}"
                                       data-upload-date="{{ item.uploadDate|string }}">
                                    <i class="fas fa-spinner"></i> Processing...
                                </button>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                
                    {% if not data %}
                    <tr>
                        <td colspan="5" class="text-center">No data available</td>
                    </tr>
                    {% endif %}
                </tbody>                
            </table>
        </div>
    </div>
</div>

<!-- Custom Alert Modal -->
<div class="modal fade" id="duplicateFileModal" tabindex="-1" aria-labelledby="duplicateFileModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title" id="duplicateFileModalLabel">
                    <i class="fas fa-exclamation-triangle"></i> Peringatan
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p><strong>Nama File sudah ada!</strong></p>
                <p>Harap masukkan nama file yang lain.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
            </div>
        </div>
    </div>
</div>

<script>
    // Get existing file names from the table for client-side check
    const existingFileNames = [
        {% for item in data %}
        "{{ item.namaFileUpload }}",
        {% endfor %}
    ];

    // Function to check if filename already exists
    function checkFilenameExists(filename) {
        return existingFileNames.includes(filename.trim());
    }

    // Function to show duplicate file alert
    function showDuplicateFileAlert() {
        // Show Bootstrap modal
        const modal = new bootstrap.Modal(document.getElementById('duplicateFileModal'));
        modal.show();
        
        // Also show browser alert as backup
        alert("Nama File sudah ada, harap masukkan nama file yang lain");
    }

    // Real-time validation on input
    document.getElementById('nama_file').addEventListener('input', function() {
        const filename = this.value.trim();
        const errorDiv = document.getElementById('filename-error');
        const submitBtn = document.getElementById('submitBtn');
        
        if (filename && checkFilenameExists(filename)) {
            // Show error message
            errorDiv.style.display = 'block';
            this.classList.add('is-invalid');
            submitBtn.disabled = true;
        } else {
            // Hide error message
            errorDiv.style.display = 'none';
            this.classList.remove('is-invalid');
            submitBtn.disabled = false;
        }
    });

    // Form submission validation
    document.getElementById('uploadForm').addEventListener('submit', function(e) {
        const filenameInput = document.getElementById('nama_file');
        const filename = filenameInput.value.trim();
        
        // Client-side check
        if (checkFilenameExists(filename)) {
            e.preventDefault();
            showDuplicateFileAlert();
            filenameInput.focus();
            return false;
        }
        
        // Server-side check via AJAX before actual form submission
        e.preventDefault();
        
        const submitBtn = document.getElementById('submitBtn');
        const originalText = submitBtn.textContent;
        
        // Show loading state
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Checking...';
        
        // Check with server
        fetch('/check-filename', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ 'nama_file': filename })
        })
        .then(response => response.json())
        .then(data => {
            if (data.exists) {
                // File exists - show alert
                showDuplicateFileAlert();
                filenameInput.focus();
                filenameInput.classList.add('is-invalid');
                document.getElementById('filename-error').style.display = 'block';
            } else {
                // File doesn't exist - proceed with form submission
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';
                this.submit();
            }
        })
        .catch(error => {
            console.error('Error checking filename:', error);
            // If check fails, proceed with form submission
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';
            this.submit();
        })
        .finally(() => {
            // Reset button state if not proceeding with upload
            setTimeout(() => {
                if (submitBtn.innerHTML.includes('Checking')) {
                    submitBtn.disabled = false;
                    submitBtn.textContent = originalText;
                }
            }, 1000);
        });
    });

    // Auto-submit on dropdown change
    document.querySelectorAll('.filter-section select').forEach(select => {
        select.addEventListener('change', function() {
            this.form.submit();
        });
    });

    document.addEventListener("DOMContentLoaded", function () {
        // Get all task IDs (avoid null values)
        const taskIds = {{ data | map(attribute='task_id') | list | tojson }}.filter(id => id !== null);
        const completedTasks = new Set();
        const totalTasks = new Set(taskIds).size;
        let activeTaskCount = 0;

        // Track tasks that are already at 100% to avoid unnecessary polling
        // and count active tasks (those not at 100%)
        document.querySelectorAll('[id^="progress-bar-"]').forEach(bar => {
            if (bar.getAttribute("aria-valuenow") === "100") {
                const taskId = bar.id.replace('progress-bar-', '');
                completedTasks.add(taskId);
            } else {
                activeTaskCount++;
            }
        });

        console.log(`Initial status: ${completedTasks.size} completed tasks, ${activeTaskCount} active tasks`);

        // Function to show alert and handle reload based on completion status
        function handleTaskCompletion(taskId) {
            // Add to completed tasks if not already there
            if (!completedTasks.has(taskId)) {
                completedTasks.add(taskId);
                activeTaskCount--;
                
                console.log(`Task ${taskId} completed. Active tasks remaining: ${activeTaskCount}`);
                
                // Check if all tasks are completed
                if (activeTaskCount <= 0) {
                    // All tasks completed - show alert and reload on confirmation
                    console.log("All tasks completed, showing reload alert");
                    if (confirm("Semua file berhasil diupload! Klik OK untuk merefresh halaman.")) {
                        window.location.reload();
                    }
                } else {
                    // Some tasks completed but others still processing - show non-reloading alert
                    console.log("Some tasks still processing, showing non-reload alert");
                    alert("File berhasil diupload! Masih ada proses upload lain yang sedang berjalan.");
                }
            }
        }

        // Poll for task status updates
        taskIds.forEach(taskId => {
            // Skip completed tasks
            if (completedTasks.has(taskId)) return;
            
            // Handle "null" task_id case - backend treats these as completed
            if (taskId === "null" || !taskId) {
                completedTasks.add(taskId);
                return;
            }
            
            const progressBar = document.getElementById(`progress-bar-${taskId}`);
            const downloadBtn = document.getElementById(`download-btn-${taskId}`);
            
            if (!progressBar || !downloadBtn) return;

            function pollStatus() {
                // Only poll if task is not completed
                if (completedTasks.has(taskId)) return;
                
                fetch(`/api/task-status-big-size-file/${taskId}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! Status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (data.status === "completed") {
                            // Update UI
                            progressBar.style.width = "100%";
                            progressBar.classList.remove("progress-bar-animated");
                            progressBar.innerText = "100%";
                            progressBar.setAttribute("aria-valuenow", "100");
        
                            // Convert button to link with proper URL
                            const periodeData = downloadBtn.getAttribute('data-periode-data');
                            const username = downloadBtn.getAttribute('data-username');
                            const namaFile = downloadBtn.getAttribute('data-nama-file');
                            const uploadDate = downloadBtn.getAttribute('data-upload-date');
                            
                            // Create download URLs
                            const downloadExcelUrl = `/download-big-size/${encodeURIComponent(periodeData)}/${encodeURIComponent(username)}/${encodeURIComponent(namaFile)}/${encodeURIComponent(uploadDate)}`;
                            const downloadZipUrl = `/download_upload/${encodeURIComponent(periodeData)}/${encodeURIComponent(username)}/${encodeURIComponent(namaFile)}/${encodeURIComponent(uploadDate)}`;
                            
                            // Create button group with both download options
                            const btnGroup = document.createElement('div');
                            btnGroup.className = "btn-group";
                            btnGroup.setAttribute('role', 'group');
                            btnGroup.setAttribute('aria-label', 'Download options');
                            
                            // Excel download button
                            const excelBtn = document.createElement('a');
                            excelBtn.href = downloadExcelUrl;
                            excelBtn.id = downloadBtn.id;
                            excelBtn.className = "btn btn-success btn-sm";
                            excelBtn.title = "Download Excel";
                            excelBtn.innerHTML = `<i class="fas fa-file-excel"></i> Excel`;
                            
                            // ZIP download button
                            const zipBtn = document.createElement('a');
                            zipBtn.href = downloadZipUrl;
                            zipBtn.id = downloadBtn.id.replace('download-btn-', 'download-zip-btn-');
                            zipBtn.className = "btn btn-info btn-sm";
                            zipBtn.title = "Download All Files as ZIP";
                            zipBtn.innerHTML = `<i class="fas fa-file-archive"></i> ZIP`;
                            
                            // Add buttons to group
                            btnGroup.appendChild(excelBtn);
                            btnGroup.appendChild(zipBtn);
                            
                            // Replace the old button with the new button group
                            downloadBtn.parentNode.replaceChild(btnGroup, downloadBtn);
        
                            // Show alert only once per task
                            if (!sessionStorage.getItem(`alert_shown_${taskId}`)) {
                                sessionStorage.setItem(`alert_shown_${taskId}`, 'true');
                                handleTaskCompletion(taskId);
                            }
                        } else if (data.status === "error") {
                            completedTasks.add(taskId);
                            activeTaskCount--;
                            
                            progressBar.classList.add("bg-danger");
                            progressBar.innerText = "Error";
                            
                            console.log(`Task ${taskId} failed with error. Active tasks remaining: ${activeTaskCount}`);
                            
                            // Check if this was the last active task
                            if (activeTaskCount <= 0) {
                                console.log("All tasks completed (some with errors), showing reload alert");
                                if (confirm("Semua proses upload selesai, namun beberapa mengalami error. Klik OK untuk merefresh halaman.")) {
                                    window.location.reload();
                                }
                            }
                        } else {
                            // Continue polling only if task is still in progress
                            setTimeout(pollStatus, 5000);
                        }
                    })
                    .catch(error => {
                        console.error("Error polling task status:", error);
                        // If we get too many errors (e.g., endpoint not responding),
                        // consider the task as failed
                        pollStatus.errorCount = (pollStatus.errorCount || 0) + 1;
                        if (pollStatus.errorCount > 3) {
                            console.warn(`Too many polling errors for task ${taskId}, marking as error`);
                            completedTasks.add(taskId);
                            activeTaskCount--;
                            
                            if (progressBar) {
                                progressBar.classList.add("bg-danger");
                                progressBar.innerText = "Error";
                            }
                            
                            // Check if this was the last active task
                            if (activeTaskCount <= 0) {
                                console.log("All tasks completed (some with errors), showing reload alert");
                                if (confirm("Semua proses upload selesai, namun beberapa mengalami error. Klik OK untuk merefresh halaman.")) {
                                    window.location.reload();
                                }
                            }
                        } else {
                            // Retry with backoff
                            setTimeout(pollStatus, 10000);
                        }
                    });
            }
        
            // Start polling if task is not completed
            pollStatus();
        });

        // Poll for progress updates
        function pollProgress() {
            // Only get progress bars for tasks that aren't completed
            taskIds.forEach(taskId => {
                // Skip completed tasks
                if (completedTasks.has(taskId)) return;
                
                const progressBar = document.getElementById(`progress-bar-${taskId}`);
                const downloadBtn = document.getElementById(`download-btn-${taskId}`);
                
                if (!progressBar || !downloadBtn) return;

                fetch(`/progress-status/${taskId}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! Status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        const progress = data.progress;
                        
                        // Update progress bar
                        progressBar.style.width = progress + "%";
                        progressBar.setAttribute("aria-valuenow", progress);
                        progressBar.textContent = progress + "%";

                        // If progress reaches 100%, mark as completed
                        if (progress >= 100) {
                            // Update UI
                            progressBar.classList.remove("progress-bar-animated");
                            
                            // Convert button to link with proper URL
                            const periodeData = downloadBtn.getAttribute('data-periode-data');
                            const username = downloadBtn.getAttribute('data-username');
                            const namaFile = downloadBtn.getAttribute('data-nama-file');
                            const uploadDate = downloadBtn.getAttribute('data-upload-date');
                            
                            // Create download URLs
                            const downloadExcelUrl = `/download-big-size/${encodeURIComponent(periodeData)}/${encodeURIComponent(username)}/${encodeURIComponent(namaFile)}/${encodeURIComponent(uploadDate)}`;
                            const downloadZipUrl = `/download_upload/${encodeURIComponent(periodeData)}/${encodeURIComponent(username)}/${encodeURIComponent(namaFile)}/${encodeURIComponent(uploadDate)}`;
                            
                            // Create button group with both download options
                            const btnGroup = document.createElement('div');
                            btnGroup.className = "btn-group";
                            btnGroup.setAttribute('role', 'group');
                            btnGroup.setAttribute('aria-label', 'Download options');
                            
                            // Excel download button
                            const excelBtn = document.createElement('a');
                            excelBtn.href = downloadExcelUrl;
                            excelBtn.id = downloadBtn.id;
                            excelBtn.className = "btn btn-success btn-sm";
                            excelBtn.title = "Download Excel";
                            excelBtn.innerHTML = `<i class="fas fa-file-excel"></i> Excel`;
                            
                            // ZIP download button
                            const zipBtn = document.createElement('a');
                            zipBtn.href = downloadZipUrl;
                            zipBtn.id = downloadBtn.id.replace('download-btn-', 'download-zip-btn-');
                            zipBtn.className = "btn btn-info btn-sm";
                            zipBtn.title = "Download All Files as ZIP";
                            zipBtn.innerHTML = `<i class="fas fa-file-archive"></i> ZIP`;
                            
                            // Add buttons to group
                            btnGroup.appendChild(excelBtn);
                            btnGroup.appendChild(zipBtn);
                            
                            // Replace the old button with the new button group
                            downloadBtn.parentNode.replaceChild(btnGroup, downloadBtn);
                            
                            // Show alert only once per task
                            if (!sessionStorage.getItem(`alert_shown_${taskId}`)) {
                                sessionStorage.setItem(`alert_shown_${taskId}`, 'true');
                                handleTaskCompletion(taskId);
                            }
                        }
                    })
                    .catch(error => {
                        console.error("Polling error:", error);
                        // Similar error handling as in pollStatus
                        pollProgress.errorCount = (pollProgress.errorCount || 0) + 1;
                        if (pollProgress.errorCount > 3) {
                            console.warn(`Too many progress polling errors for task ${taskId}, marking as error`);
                            completedTasks.add(taskId);
                            activeTaskCount--;
                            
                            if (progressBar) {
                                progressBar.classList.add("bg-danger");
                                progressBar.innerText = "Error";
                            }
                        }
                    });
            });
            
            // Continue polling only if there are uncompleted tasks
            if (taskIds.some(id => !completedTasks.has(id))) {
                setTimeout(pollProgress, 3000);
            }
        }
        
        // Start progress polling if there are uncompleted tasks
        if (taskIds.length > 0 && taskIds.some(id => !completedTasks.has(id))) {
            pollProgress();
        }
    });
</script>
{% endblock %}

<script src="{{ url_for('static', filename='js/bootstrap.bundle.min.js') }}"></script>