{% extends "header.html" %}

{% block title %}User Management{% endblock %}

{% block content %}
<div class="container-fluid px-2 px-sm-3 px-lg-4 py-3 py-lg-4">
    <!-- Page Header -->
    <div class="row mb-3 mb-lg-4">
        <div class="col-12">
            <div class="d-flex flex-column flex-sm-row justify-content-between align-items-start align-items-sm-center gap-2">
                <div>
                    <h2 class="mb-1 fw-bold fs-3 fs-lg-2">User Management</h2>
                    <p class="text-muted mb-0 small">Manage system users, roles, and permissions</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-3 mb-lg-4 g-2 g-sm-3">
        <div class="col-6 col-lg-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body p-2 p-sm-3">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <div class="rounded-circle bg-primary bg-opacity-10 p-2 p-sm-3">
                                <i class="bi bi-people-fill text-primary fs-5 fs-sm-4"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-2 ms-sm-3">
                            <h6 class="text-muted mb-1 small">Total Users</h6>
                            <h3 class="mb-0 fw-bold fs-4 fs-sm-3" id="totalUsers">0</h3>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-6 col-lg-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body p-2 p-sm-3">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <div class="rounded-circle bg-danger bg-opacity-10 p-2 p-sm-3">
                                <i class="bi bi-shield-fill-check text-danger fs-5 fs-sm-4"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-2 ms-sm-3">
                            <h6 class="text-muted mb-1 small">Administrators</h6>
                            <h3 class="mb-0 fw-bold fs-4 fs-sm-3" id="totalAdmins">0</h3>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-6 col-lg-3">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body p-2 p-sm-3">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <div class="rounded-circle bg-info bg-opacity-10 p-2 p-sm-3">
                                <i class="bi bi-person-badge-fill text-info fs-5 fs-sm-4"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-2 ms-sm-3">
                            <h6 class="text-muted mb-1 small">Regular Users</h6>
                            <h3 class="mb-0 fw-bold fs-4 fs-sm-3" id="totalRegularUsers">0</h3>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Users Table Card -->
    <div class="card border-0 shadow-sm">
        <div class="card-header bg-white border-bottom py-2 py-sm-3">
            <button type="button" class="btn btn-primary btn-sm btn-lg-lg shadow-sm w-100 w-sm-auto" onclick="showCreateModal()" aria-label="Open dialog to create a new user">
                <i class="bi bi-plus-circle me-1 me-sm-2"></i>Create New User
            </button>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table id="userTable" class="table table-hover align-middle mb-0" style="width:100%">
                    <thead class="bg-light">
                        <tr>
                            <th class="px-2 px-sm-3 px-lg-4 py-2 py-sm-3 text-muted fw-semibold small">Username</th>
                            <th class="px-2 px-sm-3 px-lg-4 py-2 py-sm-3 text-muted fw-semibold small d-none d-md-table-cell">Full Name</th>
                            <th class="px-2 px-sm-3 px-lg-4 py-2 py-sm-3 text-muted fw-semibold small d-none d-lg-table-cell">Email</th>
                            <th class="px-2 px-sm-3 px-lg-4 py-2 py-sm-3 text-muted fw-semibold small">Role</th>
                            <th class="px-2 px-sm-3 px-lg-4 py-2 py-sm-3 text-muted fw-semibold small d-none d-xl-table-cell">Report Access</th>
                            <th class="px-2 px-sm-3 px-lg-4 py-2 py-sm-3 text-muted fw-semibold text-center small">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal Create/Edit User -->
<div class="modal fade" id="userModal" tabindex="-1" aria-labelledby="userModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg modal-dialog-scrollable">
        <div class="modal-content border-0 shadow">
            <div class="modal-header border-bottom bg-light">
                <div>
                    <h5 class="modal-title fw-bold fs-5 fs-sm-4" id="userModalLabel">Create New User</h5>
                    <p class="text-muted small mb-0" id="userModalSubtitle">Fill in the information below</p>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-3 p-sm-4">
                <form id="userForm">
                    <input type="hidden" id="userId" name="id">
                    
                    <div class="row g-2 g-sm-3">
                        <div class="col-12 col-md-6">
                            <label for="username" class="form-label fw-semibold small">
                                <i class="bi bi-person-circle me-1"></i>Username
                                <span class="text-danger">*</span>
                            </label>
                            <input type="text" class="form-control" id="username" name="username"
                                   placeholder="Enter username" required aria-required="true" aria-describedby="usernameHelp">
                            <div class="form-text small" id="usernameHelp">Username must be unique</div>
                        </div>
                        
                        <div class="col-12 col-md-6">
                            <label for="modal_fullname" class="form-label fw-semibold small">
                                <i class="bi bi-person-fill me-1"></i>Full Name 
                                <span class="text-danger">*</span>
                            </label>
                            <input type="text" class="form-control" id="modal_fullname" name="modal_fullname" 
                                   placeholder="Enter full name" required>
                        </div>
                    </div>
                    
                    <div class="mb-2 mb-sm-3">
                        <label for="email" class="form-label fw-semibold small">
                            <i class="bi bi-envelope-fill me-1"></i>Email Address
                            <span class="text-danger">*</span>
                        </label>
                        <input type="email" class="form-control" id="email" name="email"
                               placeholder="user@example.com" required aria-required="true" aria-describedby="emailHelp">
                        <div class="form-text small" id="emailHelp">Email must be unique and valid</div>
                    </div>
                    
                    <div class="row g-2 g-sm-3" id="passwordSection">
                        <div class="col-12 col-md-6" id="passwordGroup">
                            <label for="password" class="form-label fw-semibold small">
                                <i class="bi bi-lock-fill me-1"></i>Password
                                <span class="text-danger">*</span>
                            </label>
                            <div class="position-relative">
                                <input type="password" class="form-control password-input"
                                       id="password" name="password" placeholder="Enter password"
                                       aria-required="true" aria-describedby="passwordHelp">
                                <i class="bi bi-eye-slash password-toggle" onclick="togglePassword('password', this)"
                                   role="button" tabindex="0" aria-label="Toggle password visibility"
                                   onkeypress="if(event.key==='Enter' || event.key===' ') togglePassword('password', this)"></i>
                            </div>
                            <div class="password-requirements mt-2 p-2 bg-light rounded" id="passwordHelp" role="region" aria-live="polite" aria-label="Password requirements">
                                <small class="d-block mb-1"><span id="lengthCheck" class="invalid" aria-label="Minimum 9 characters">✖</span> Minimal 9 characters</small>
                                <small class="d-block mb-1"><span id="capitalCheck" class="invalid" aria-label="Contains uppercase letter">✖</span> Contains uppercase letter</small>
                                <small class="d-block mb-1"><span id="numberCheck" class="invalid" aria-label="Contains number">✖</span> Contains number</small>
                                <small class="d-block"><span id="specialCheck" class="invalid" aria-label="Contains special character">✖</span> Contains special character (@$!%*?&)</small>
                            </div>
                        </div>
                        
                        <div class="col-12 col-md-6" id="confirmPasswordGroup">
                            <label for="password_confirm" class="form-label fw-semibold small">
                                <i class="bi bi-lock-fill me-1"></i>Confirm Password
                                <span class="text-danger">*</span>
                            </label>
                            <div class="position-relative">
                                <input type="password" class="form-control password-input"
                                       id="password_confirm" name="password_confirm" placeholder="Re-enter password"
                                       aria-required="true" aria-describedby="matchCheck">
                                <i class="bi bi-eye-slash password-toggle" onclick="togglePassword('password_confirm', this)"
                                   role="button" tabindex="0" aria-label="Toggle password visibility"
                                   onkeypress="if(event.key==='Enter' || event.key===' ') togglePassword('password_confirm', this)"></i>
                            </div>
                            <small id="matchCheck" class="text-danger" style="display:none;" role="alert">
                                <i class="bi bi-exclamation-circle me-1"></i>Passwords do not match
                            </small>
                        </div>
                    </div>

                    <div class="row g-2 g-sm-3">
                        <div class="col-12 col-md-6">
                            <label for="role_access" class="form-label fw-semibold small">
                                <i class="bi bi-shield-check me-1"></i>Role Access
                                <span class="text-danger">*</span>
                            </label>
                            <select class="form-select" id="role_access" name="role_access" required
                                    aria-required="true" aria-label="Select user role">
                                <option value="">Select role...</option>
                                <option value="user">User</option>
                                <option value="admin">Admin</option>
                            </select>
                        </div>

                        <div class="col-12 col-md-6">
                            <label for="report_access" class="form-label fw-semibold small">
                                <i class="bi bi-file-earmark-bar-graph me-1"></i>Report Access
                                <span class="text-danger">*</span>
                            </label>
                            <select class="form-select" id="report_access" name="report_access" required
                                    aria-required="true" aria-label="Select report access level">
                                <option value="">Select access level...</option>
                                <option value="0">Upload Only</option>
                                <option value="1">Report Only</option>
                                <option value="2">Full Access</option>
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-top bg-light">
                <button type="button" class="btn btn-secondary px-3 px-sm-4" data-bs-dismiss="modal" aria-label="Close dialog without saving">
                    <i class="bi bi-x-circle me-1 me-sm-2"></i>Cancel
                </button>
                <button type="button" class="btn btn-primary px-3 px-sm-4" onclick="saveUser()" aria-label="Save user information">
                    <i class="bi bi-check-circle me-1 me-sm-2"></i>Save User
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Reset Password -->
<div class="modal fade" id="resetPasswordModal" tabindex="-1" aria-labelledby="resetPasswordModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg modal-dialog-scrollable">
        <div class="modal-content border-0 shadow">
            <div class="modal-header border-bottom bg-light">
                <div>
                    <h5 class="modal-title fw-bold fs-5 fs-sm-4" id="resetPasswordModalLabel">Reset Password</h5>
                    <p class="text-muted small mb-0">Enter a new password for the user</p>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-3 p-sm-4">
                <form id="resetPasswordForm">
                    <input type="hidden" id="resetUserId" name="id">

                    <div class="mb-3 mb-sm-4">
                        <label for="resetUsername" class="form-label fw-semibold small">
                            <i class="bi bi-person-circle me-1"></i>Username
                        </label>
                        <input type="text" class="form-control" id="resetUsername" name="resetUsername"
                               placeholder="Username" disabled>
                        <small class="text-muted">Username cannot be changed</small>
                    </div>

                    <div class="mb-2 mb-sm-3">
                        <label for="resetPassword" class="form-label fw-semibold small">
                            <i class="bi bi-lock-fill me-1"></i>New Password
                            <span class="text-danger">*</span>
                        </label>
                        <div class="position-relative">
                            <input type="password" class="form-control password-input"
                                   id="resetPassword" name="resetPassword" placeholder="Enter new password"
                                   aria-required="true" aria-describedby="resetPasswordHelp">
                            <i class="bi bi-eye-slash password-toggle" onclick="togglePassword('resetPassword', this)"
                               role="button" tabindex="0" aria-label="Toggle password visibility"
                               onkeypress="if(event.key==='Enter' || event.key===' ') togglePassword('resetPassword', this)"></i>
                        </div>
                        <div class="password-requirements mt-2 p-2 bg-light rounded" id="resetPasswordHelp" role="region" aria-live="polite" aria-label="Password requirements">
                            <small class="d-block mb-1"><span id="resetLengthCheck" class="invalid" aria-label="Minimum 9 characters">✖</span> Minimal 9 characters</small>
                            <small class="d-block mb-1"><span id="resetCapitalCheck" class="invalid" aria-label="Contains uppercase letter">✖</span> Contains uppercase letter</small>
                            <small class="d-block mb-1"><span id="resetNumberCheck" class="invalid" aria-label="Contains number">✖</span> Contains number</small>
                            <small class="d-block"><span id="resetSpecialCheck" class="invalid" aria-label="Contains special character">✖</span> Contains special character (@$!%*?&)</small>
                        </div>
                    </div>

                    <div class="mb-2 mb-sm-3">
                        <label for="resetPasswordConfirm" class="form-label fw-semibold small">
                            <i class="bi bi-lock-fill me-1"></i>Confirm Password
                            <span class="text-danger">*</span>
                        </label>
                        <div class="position-relative">
                            <input type="password" class="form-control password-input"
                                   id="resetPasswordConfirm" name="resetPasswordConfirm" placeholder="Re-enter password"
                                   aria-required="true" aria-describedby="resetMatchCheck">
                            <i class="bi bi-eye-slash password-toggle" onclick="togglePassword('resetPasswordConfirm', this)"
                               role="button" tabindex="0" aria-label="Toggle password visibility"
                               onkeypress="if(event.key==='Enter' || event.key===' ') togglePassword('resetPasswordConfirm', this)"></i>
                        </div>
                        <small id="resetMatchCheck" class="text-danger" style="display:none;" role="alert">
                            <i class="bi bi-exclamation-circle me-1"></i>Passwords do not match
                        </small>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-top bg-light">
                <button type="button" class="btn btn-secondary px-3 px-sm-4" data-bs-dismiss="modal" aria-label="Close dialog without saving">
                    <i class="bi bi-x-circle me-1 me-sm-2"></i>Cancel
                </button>
                <button type="button" class="btn btn-primary px-3 px-sm-4" onclick="saveResetPassword()" aria-label="Reset user password">
                    <i class="bi bi-check-circle me-1 me-sm-2"></i>Save Changes
                </button>
            </div>
        </div>
    </div>
</div>

<link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css">
<link rel="stylesheet" href="static/bootstrap-icons.css">

<style>
    /* Custom Responsive Styles */
    body {
        background-color: #f8f9fa;
    }

    .card {
        border-radius: 12px;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 0.5rem 1.5rem rgba(0, 0, 0, 0.1) !important;
    }

    .password-toggle {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        cursor: pointer;
        color: #6c757d;
        font-size: 1.1rem;
        z-index: 10;
        transition: color 0.2s ease;
    }

    .password-toggle:hover {
        color: #495057;
    }

    .password-input {
        padding-right: 40px;
    }

    .password-requirements span.valid {
        color: #28a745;
    }

    .password-requirements span.invalid {
        color: #dc3545;
    }

    .action-buttons {
        white-space: nowrap;
    }

    .table > :not(caption) > * > * {
        padding: 0.5rem;
    }

    @media (min-width: 768px) {
        .table > :not(caption) > * > * {
            padding: 0.75rem;
        }
    }

    @media (min-width: 992px) {
        .table > :not(caption) > * > * {
            padding: 1rem;
        }
    }

    .table tbody tr {
        transition: background-color 0.2s ease;
    }

    .table tbody tr:hover {
        background-color: #f8f9fa;
    }

    .btn {
        border-radius: 8px;
        font-weight: 500;
        transition: all 0.2s ease;
    }

    .btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .btn-secondary {
        width: 100%;
        background: #c21a1aff;
        border: none;
        padding: 10px;
        border-radius: 6px;
        transition: background 0.3s;
        font-size: 1.125rem;
        cursor: pointer;
    }

    .btn-secondary:hover {
        background: #a01515ff;
    }

    .badge {
        padding: 0.35rem 0.65rem;
        font-weight: 500;
        border-radius: 6px;
        font-size: 0.75rem;
    }

    .modal-content {
        border-radius: 16px;
    }

    .form-control:focus, .form-select:focus {
        border-color: #0d6efd;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.15);
    }

    /* DataTables Responsive Styling */
    .dataTables_wrapper {
        font-size: 0.875rem;
    }

    @media (max-width: 767px) {
        .dataTables_wrapper .dataTables_length,
        .dataTables_wrapper .dataTables_filter {
            text-align: center;
            margin-bottom: 0.5rem;
        }

        .dataTables_wrapper .dataTables_length label,
        .dataTables_wrapper .dataTables_filter label {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
        }
    }

    .dataTables_wrapper .dataTables_length select,
    .dataTables_wrapper .dataTables_filter input {
        border-radius: 8px;
        border: 1px solid #dee2e6;
        padding: 0.375rem 0.75rem;
        font-size: 0.875rem;
    }

    .dataTables_wrapper .dataTables_filter input {
        width: 100%;
        max-width: 200px;
    }

    @media (min-width: 768px) {
        .dataTables_wrapper .dataTables_filter input {
            max-width: 250px;
        }
    }

    .dataTables_wrapper .dataTables_filter input:focus {
        border-color: #0d6efd;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.15);
        outline: none;
    }

    .dataTables_wrapper .dataTables_paginate .paginate_button.current {
        background: #0d6efd !important;
        border-color: #0d6efd !important;
        color: white !important;
        border-radius: 8px;
    }

    .dataTables_wrapper .dataTables_paginate .paginate_button {
        border-radius: 8px !important;
        margin: 0 2px;
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
    }

    .dataTables_wrapper .dataTables_info,
    .dataTables_wrapper .dataTables_paginate {
        font-size: 0.875rem;
    }

    @media (max-width: 767px) {
        .dataTables_wrapper .dataTables_info,
        .dataTables_wrapper .dataTables_paginate {
            text-align: center;
            margin-top: 0.5rem;
        }
    }

    /* Button Group Responsive */
    .btn-group {
        display: flex;
        gap: 0.25rem;
    }

    .btn-group .btn-sm {
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
    }

    /* Statistics Cards Responsive */
    @media (max-width: 575px) {
        .card-body h6 {
            font-size: 0.75rem;
        }
        
        .rounded-circle {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    }

    /* Modal Responsive */
    @media (max-width: 767px) {
        .modal-dialog {
            margin: 0.5rem;
        }

        .modal-body {
            max-height: calc(100vh - 200px);
            overflow-y: auto;
        }
    }

    /* Statistics Cards Animation */
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .card {
        animation: fadeInUp 0.5s ease;
    }

    /* Alert Responsive */
    .alert.position-fixed {
        min-width: 250px;
        max-width: 90%;
    }

    @media (min-width: 576px) {
        .alert.position-fixed {
            min-width: 300px;
            max-width: 500px;
        }
    }
</style>

<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>

<script>
    var table;
    var isEditMode = false;

    function getCsrfToken() {
        const name = 'csrf_token=';
        const decodedCookie = decodeURIComponent(document.cookie);
        const cookieArray = decodedCookie.split(';');
        for (let i = 0; i < cookieArray.length; i++) {
            let cookie = cookieArray[i].trim();
            if (cookie.indexOf(name) === 0) {
                return cookie.substring(name.length);
            }
        }
        // Fallback: check meta tag
        const csrfMeta = document.querySelector('meta[name="csrf-token"]');
        return csrfMeta ? csrfMeta.getAttribute('content') : '';
    }

    $(document).ready(function() {
        loadUsers();
    });

    function loadUsers() {
        if (table) {
            table.destroy();
        }

        table = $('#userTable').DataTable({
            ajax: {
                url: '/api/users',
                dataSrc: function(json) {
                    updateStatistics(json);
                    return json;
                }
            },
            columns: [
                { 
                    data: 'username',
                    className: 'px-2 px-sm-3 px-lg-4',
                    render: function(data) {
                        return `<div class="d-flex align-items-center">
                                    <i class="bi bi-person-circle me-2 text-primary fs-6 fs-sm-5"></i>
                                    <span class="fw-semibold small">${data}</span>
                                </div>`;
                    }
                },
                { 
                    data: 'fullname',
                    className: 'px-2 px-sm-3 px-lg-4 d-none d-md-table-cell',
                    render: function(data) {
                        return `<span class="small">${data}</span>`;
                    }
                },
                { 
                    data: 'email',
                    className: 'px-2 px-sm-3 px-lg-4 d-none d-lg-table-cell',
                    render: function(data) {
                        return `<small class="text-muted">${data}</small>`;
                    }
                },
                { 
                    data: 'role_access',
                    className: 'px-2 px-sm-3 px-lg-4',
                    render: function(data) {
                        return data === 'admin' ? 
                            '<span class="badge bg-danger"><i class="bi bi-shield-fill-check me-1"></i>Admin</span>' : 
                            '<span class="badge bg-primary"><i class="bi bi-person-badge me-1"></i>User</span>';
                    }
                },
                { 
                    data: 'report_access',
                    className: 'px-2 px-sm-3 px-lg-4 d-none d-xl-table-cell',
                    render: function(data) {
                        if (data == 0) return '<span class="badge bg-secondary">Upload Only</span>';
                        if (data == 1) return '<span class="badge bg-info">Report Only</span>';
                        if (data == 2) return '<span class="badge bg-success"><i class="bi bi-check-circle me-1"></i>Full Access</span>';
                        return data;
                    }
                },
                {
                    data: null,
                    orderable: false,
                    className: 'action-buttons px-2 px-sm-3 px-lg-4 text-center',
                    render: function(data, type, row) {
                        return `
                            <div class="btn-group" role="group" aria-label="User actions">
                                <button class="btn btn-sm btn-warning" data-user-id="${row.id}" onclick="editUser(this)"
                                        title="Edit User" aria-label="Edit user ${row.username}">
                                    <i class="bi bi-pencil-square"></i>
                                </button>
                                <button class="btn btn-sm btn-info" data-user-id="${row.id}" data-user-name="${row.username}" onclick="resetPasswordUser(this)"
                                        title="Reset Password" aria-label="Reset password for user ${row.username}">
                                    <i class="bi bi-key-fill"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" data-user-id="${row.id}" data-user-name="${row.username}" onclick="deleteUser(this)"
                                        title="Delete User" aria-label="Delete user ${row.username}">
                                    <i class="bi bi-trash-fill"></i>
                                </button>
                            </div>
                        `;
                    }
                }
            ],
            order: [[0, 'desc']],
            pageLength: 10,
            responsive: true,
            language: {
                search: "_INPUT_",
                searchPlaceholder: "Search users...",
                lengthMenu: "Show _MENU_",
                info: "Showing _START_ to _END_ of _TOTAL_",
                infoEmpty: "No users found",
                infoFiltered: "(filtered from _MAX_ total)",
                paginate: {
                    first: '<i class="bi bi-chevron-double-left"></i>',
                    last: '<i class="bi bi-chevron-double-right"></i>',
                    next: '<i class="bi bi-chevron-right"></i>',
                    previous: '<i class="bi bi-chevron-left"></i>'
                }
            },
            dom: '<"row"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>>rtip',
            drawCallback: function() {
                $('.dataTables_paginate > .pagination').addClass('pagination-sm');
            }
        });
    }

    function updateStatistics(data) {
        const totalUsers = data.length;
        const totalAdmins = data.filter(u => u.role_access === 'admin').length;
        const totalRegularUsers = data.filter(u => u.role_access === 'user').length;

        $('#totalUsers').text(totalUsers);
        $('#totalAdmins').text(totalAdmins);
        $('#totalRegularUsers').text(totalRegularUsers);
    }

    function showCreateModal() {
        isEditMode = false;
        document.getElementById('userModalLabel').textContent = 'Create New User';
        document.getElementById('userModalSubtitle').textContent = 'Fill in the information below';
        document.getElementById('userForm').reset();
        document.getElementById('userId').value = '';
        document.getElementById('passwordSection').style.display = 'block';
        document.getElementById('password').required = true;
        document.getElementById('password_confirm').required = true;
        resetPasswordChecks();

        var modal = new bootstrap.Modal(document.getElementById('userModal'));
        modal.show();

        // Focus on first input for accessibility
        setTimeout(() => document.getElementById('username').focus(), 500);
    }

    function editUser(button) {
        isEditMode = true;
        const id = button.getAttribute('data-user-id');
        document.getElementById('userModalLabel').textContent = 'Edit User';
        document.getElementById('userModalSubtitle').textContent = 'Update user information';

        fetch(`/api/users/${id}`, {
            headers: {
                'X-CSRF-Token': getCsrfToken()
            }
        })
            .then(response => {
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                return response.json();
            })
            .then(data => {
                document.getElementById('userId').value = data.id;
                document.getElementById('username').value = data.username;
                document.getElementById('modal_fullname').value = data.fullname;
                document.getElementById('email').value = data.email;
                document.getElementById('role_access').value = data.role_access;
                document.getElementById('report_access').value = data.report_access;

                document.getElementById('passwordSection').style.display = 'none';
                document.getElementById('password').required = false;
                document.getElementById('password_confirm').required = false;

                var modal = new bootstrap.Modal(document.getElementById('userModal'));
                modal.show();

                // Focus on first editable input for accessibility
                setTimeout(() => document.getElementById('modal_fullname').focus(), 500);
            })
            .catch(error => {
                showAlert('Failed to load user data. Please try again.', 'danger');
                console.error('Error:', error);
            });
    }

    function saveUser() {
        var form = document.getElementById('userForm');
        
        if (!form.checkValidity()) {
            form.classList.add('was-validated');
            showAlert('Please fill in all required fields', 'warning');
            return;
        }

        var userId = document.getElementById('userId').value;
        var username = document.getElementById('username').value;
        var fullname = document.getElementById('modal_fullname').value;
        var email = document.getElementById('email').value;
        var password = document.getElementById('password').value;
        var passwordConfirm = document.getElementById('password_confirm').value;
        var roleAccess = document.getElementById('role_access').value;
        var reportAccess = document.getElementById('report_access').value;

        // Validate password for create mode
        if (!isEditMode) {
            if (!validatePasswordStrength(password)) {
                showAlert('Password does not meet requirements', 'danger');
                return;
            }

            if (password !== passwordConfirm) {
                showAlert('Passwords do not match', 'danger');
                return;
            }
        }

        var data = {
            username: username,
            fullname: fullname,
            email: email,
            role_access: roleAccess,
            report_access: parseInt(reportAccess)
        };

        if (!isEditMode) {
            data.password = password;
        }

        var url = isEditMode ? `/api/users/${userId}` : '/api/users';
        var method = isEditMode ? 'PUT' : 'POST';

        // Show loading state
        const saveBtn = event.target;
        const originalText = saveBtn.innerHTML;
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Saving...';

        fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-Token': getCsrfToken()
            },
            body: JSON.stringify(data)
        })
        .then(response => {
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            return response.json();
        })
        .then(data => {
            saveBtn.disabled = false;
            saveBtn.innerHTML = originalText;

            if (data.success) {
                showAlert(data.message, 'success');
                bootstrap.Modal.getInstance(document.getElementById('userModal')).hide();
                loadUsers();
            } else {
                showAlert(data.message || 'Failed to save user.', 'danger');
            }
        })
        .catch(error => {
            saveBtn.disabled = false;
            saveBtn.innerHTML = originalText;
            showAlert('Failed to save user. Please try again.', 'danger');
            console.error('Error:', error);
        });
    }

    function deleteUser(button) {
        const id = button.getAttribute('data-user-id');
        const username = button.getAttribute('data-user-name');

        if (!confirm(`Are you sure you want to delete user "${username}"?\n\nThis action cannot be undone.`)) {
            return;
        }

        fetch(`/api/users/${id}`, {
            method: 'DELETE',
            headers: {
                'X-CSRF-Token': getCsrfToken()
            }
        })
        .then(response => {
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            return response.json();
        })
        .then(data => {
            if (data.success) {
                showAlert(data.message, 'success');
                loadUsers();
            } else {
                showAlert(data.message || 'Failed to delete user.', 'danger');
            }
        })
        .catch(error => {
            showAlert('Failed to delete user. Please try again.', 'danger');
            console.error('Error:', error);
        });
    }

    function resetPasswordUser(button) {
        const id = button.getAttribute('data-user-id');
        const username = button.getAttribute('data-user-name');

        // Reset form and display
        document.getElementById('resetPasswordForm').reset();
        document.getElementById('resetUserId').value = id;
        document.getElementById('resetUsername').value = username;
        document.getElementById('resetPassword').required = true;
        document.getElementById('resetPasswordConfirm').required = true;
        resetPasswordValidationChecks();

        var modal = new bootstrap.Modal(document.getElementById('resetPasswordModal'));
        modal.show();

        // Focus on first input for accessibility
        setTimeout(() => document.getElementById('resetPassword').focus(), 500);
    }

    function resetPasswordValidationChecks() {
        ['resetLengthCheck', 'resetCapitalCheck', 'resetNumberCheck', 'resetSpecialCheck'].forEach(id => {
            document.getElementById(id).className = 'invalid';
            document.getElementById(id).innerHTML = '❌';
        });
    }

    function saveResetPassword() {
        var form = document.getElementById('resetPasswordForm');

        if (!form.checkValidity()) {
            form.classList.add('was-validated');
            showAlert('Please fill in all required fields', 'warning');
            return;
        }

        var userId = document.getElementById('resetUserId').value;
        var password = document.getElementById('resetPassword').value;
        var passwordConfirm = document.getElementById('resetPasswordConfirm').value;

        // Validate password strength
        if (!validatePasswordStrength(password)) {
            showAlert('Password does not meet requirements', 'danger');
            return;
        }

        // Check if passwords match
        if (password !== passwordConfirm) {
            showAlert('Passwords do not match', 'danger');
            return;
        }

        var data = {
            password: password
        };

        // Show loading state
        const saveBtn = event.target;
        const originalText = saveBtn.innerHTML;
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Saving...';

        fetch(`/api/users/${userId}/reset-password`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-Token': getCsrfToken()
            },
            body: JSON.stringify(data)
        })
        .then(response => {
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            return response.json();
        })
        .then(data => {
            saveBtn.disabled = false;
            saveBtn.innerHTML = originalText;

            if (data.success) {
                showAlert(data.message, 'success');
                bootstrap.Modal.getInstance(document.getElementById('resetPasswordModal')).hide();
                loadUsers();
            } else {
                showAlert(data.message || 'Failed to reset password.', 'danger');
            }
        })
        .catch(error => {
            saveBtn.disabled = false;
            saveBtn.innerHTML = originalText;
            showAlert('Failed to reset password. Please try again.', 'danger');
            console.error('Error:', error);
        });
    }

    function togglePassword(inputId, icon) {
        var inputField = document.getElementById(inputId);
        
        if (inputField.type === "password") {
            inputField.type = "text";
            icon.classList.remove("bi-eye-slash");
            icon.classList.add("bi-eye");
        } else {
            inputField.type = "password";
            icon.classList.remove("bi-eye");
            icon.classList.add("bi-eye-slash");
        }
    }

    function resetPasswordChecks() {
        ['lengthCheck', 'capitalCheck', 'numberCheck', 'specialCheck'].forEach(id => {
            document.getElementById(id).className = 'invalid';
            document.getElementById(id).innerHTML = '❌';
        });
    }

    document.getElementById('password').addEventListener('input', function() {
        var password = this.value;

        var checks = {
            lengthCheck: password.length >= 9,
            capitalCheck: /[A-Z]/.test(password),
            numberCheck: /\d/.test(password),
            specialCheck: /[@$!%*?&]/.test(password)
        };

        Object.keys(checks).forEach(key => {
            var element = document.getElementById(key);
            element.className = checks[key] ? 'valid' : 'invalid';
            element.innerHTML = checks[key] ? '✅' : '❌';
        });
    });

    document.getElementById('password_confirm').addEventListener('input', function() {
        var password = document.getElementById('password').value;
        var confirmPassword = this.value;
        var matchCheck = document.getElementById('matchCheck');

        if (confirmPassword && password !== confirmPassword) {
            matchCheck.style.display = 'block';
        } else {
            matchCheck.style.display = 'none';
        }
    });

    // Reset password field validation
    document.getElementById('resetPassword').addEventListener('input', function() {
        var password = this.value;

        var checks = {
            resetLengthCheck: password.length >= 9,
            resetCapitalCheck: /[A-Z]/.test(password),
            resetNumberCheck: /\d/.test(password),
            resetSpecialCheck: /[@$!%*?&]/.test(password)
        };

        Object.keys(checks).forEach(key => {
            var element = document.getElementById(key);
            element.className = checks[key] ? 'valid' : 'invalid';
            element.innerHTML = checks[key] ? '✅' : '❌';
        });
    });

    document.getElementById('resetPasswordConfirm').addEventListener('input', function() {
        var password = document.getElementById('resetPassword').value;
        var confirmPassword = this.value;
        var matchCheck = document.getElementById('resetMatchCheck');

        if (confirmPassword && password !== confirmPassword) {
            matchCheck.style.display = 'block';
        } else {
            matchCheck.style.display = 'none';
        }
    });

    function validatePasswordStrength(password) {
        var hasCapital = /[A-Z]/.test(password);
        var hasNumber = /\d/.test(password);
        var hasSpecial = /[@$!%*?&]/.test(password);
        var isLongEnough = password.length >= 9;

        return isLongEnough && hasCapital && hasNumber && hasSpecial;
    }

    function showAlert(message, type) {
        // Create alert element
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3`;
        alertDiv.style.zIndex = '9999';
        alertDiv.style.minWidth = '300px';
        alertDiv.innerHTML = `
            <i class="bi bi-${type === 'success' ? 'check-circle' : type === 'danger' ? 'exclamation-circle' : 'info-circle'} me-2"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.body.appendChild(alertDiv);
        
        // Auto remove after 5 seconds
        setTimeout(() => {
            alertDiv.remove();
        }, 5000);
    }
</script>
{% endblock %}