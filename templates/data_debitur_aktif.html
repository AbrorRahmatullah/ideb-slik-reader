{% extends "header.html" %}
{% block title %}Data Debitur Aktif{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        Data Debitur Aktif (Gabungan Konvensional & Syariah)
    </div>

    <div class="card-body">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; gap: 10px;">
            <div>
                <label for="periodeFilter" class="form-label">Periode:</label>
                <input type="month" id="periodeFilter" class="form-control" style="width: 200px; display: inline-block;">
            </div>
            <div style="display: flex; gap: 10px;">
                <button id="btnFilter" class="btn-primary" style="width: auto; padding: 8px 15px;">
                    <i class="fas fa-search"></i> Tampilkan
                </button>
                <button id="btnDownload" class="btn-success" style="width: auto; padding: 8px 15px;" disabled>
                    <i class="fas fa-file-excel"></i> Download Excel
                </button>
            </div>
        </div>

        <div class="table-container">
            <table id="debiturTable" class="table table-striped table-bordered nowrap w-100">
                <thead>
                    <tr>
                        <th>Periode Data</th>
                        <th>ID Debitur</th>
                        <th>Nama Debitur</th>
                        <th>Nomor Identitas Badan Usaha</th>
                        <th>Status Nasabah</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<script>
let debiturTable;
let currentPeriode = "";

// --- INIT DATATABLE ---
function initTable() {
    debiturTable = $('#debiturTable').DataTable({
        serverSide: true,
        processing: true,
        searching: false,
        ajax: function (data, callback) {
            const page = Math.floor(data.start / data.length) + 1;
            const page_size = data.length;
            const periodeInput = document.getElementById("periodeFilter").value;
            const periode = periodeInput ? periodeInput.replace("-", "") : "";

            fetch(`/api/data-debitur-aktif?periode=${periode}&page=${page}&page_size=${page_size}`)
                .then(res => res.json())
                .then(result => {
                    if (result.success) {
                        callback({
                            recordsTotal: result.total,
                            recordsFiltered: result.total,
                            data: result.data
                        });
                        $('#btnDownload').prop('disabled', result.data.length === 0);
                    } else {
                        callback({ data: [] });
                        alert("Gagal memuat data: " + result.message);
                    }
                })
                .catch(() => {
                    callback({ data: [] });
                    alert("Terjadi kesalahan koneksi ke server.");
                });
        },
        columns: [
            { data: 'PBK_EOD_DATE', title: 'Periode Data', className: 'text-center' },
            { data: 'CUSTOMER_ID', title: 'ID Debitur', className: 'text-center' },
            { data: 'CUST_NAME', title: 'Nama Debitur' },
            { data: 'Nomor_Identitas_Badan_Usaha', title: 'Nomor Identitas Badan Usaha', className: 'text-center' },
            { data: 'CUSTOMER_STATUS', title: 'Status Nasabah', className: 'text-center' }
        ],
        pageLength: 10,
        language: { processing: "Memuat data..." },
        scrollX: true
    });
}

// --- FILTER DATA ---
function reloadTable() {
    const periodeInput = document.getElementById("periodeFilter").value;
    currentPeriode = periodeInput ? periodeInput.replace("-", "") : "";
    debiturTable.ajax.reload();
}

// --- DOWNLOAD EXCEL ---
async function downloadExcel() {
    if ($('#btnDownload').prop('disabled')) return;

    $('#btnDownload').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Mengunduh...');

    try {
        const response = await fetch('/api/download-data-debitur-aktif', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ periode: currentPeriode })
        });

        if (!response.ok) throw new Error("Gagal mengunduh file");

        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `data_debitur_aktif_${currentPeriode || 'all'}.xlsx`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        window.URL.revokeObjectURL(url);
    } catch (err) {
        console.error(err);
        alert("Terjadi kesalahan saat mengunduh file.");
    } finally {
        $('#btnDownload').prop('disabled', false).html('<i class="fas fa-file-excel"></i> Download Excel');
    }
}

// --- ON PAGE LOAD ---
document.addEventListener('DOMContentLoaded', () => {
    initTable();

    const now = new Date();
    const currentMonth = now.toISOString().slice(0, 7);
    document.getElementById("periodeFilter").value = currentMonth;
    currentPeriode = currentMonth.replace("-", "");

    document.getElementById('btnFilter').addEventListener('click', reloadTable);
    document.getElementById('btnDownload').addEventListener('click', downloadExcel);
});
</script>
{% endblock %}
