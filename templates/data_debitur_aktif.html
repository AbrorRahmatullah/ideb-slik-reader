{% extends "header.html" %}
{% block title %}Data Debitur Aktif{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        Data Debitur Aktif (Gabungan Konvensional & Syariah)
    </div>

    <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
            <div>
                <label for="periodeFilter" class="form-label mb-1">Periode:</label>
                <input type="month" id="periodeFilter" class="form-control" style="width: 200px;">
            </div>
            <div class="d-flex gap-2 align-items-end">
                <button id="btnFilter" class="btn btn-primary">
                    <i class="fas fa-search"></i> Tampilkan
                </button>
                <button id="btnDownload" class="btn btn-success" disabled>
                    <i class="fas fa-file-excel"></i> Download Excel
                </button>
            </div>
        </div>

        <div class="table-responsive">
            <table id="debiturTable" class="table table-striped table-bordered nowrap w-100">
                <thead class="table-light">
                    <tr>
                        <th>Periode Data</th>
                        <th>ID Debitur</th>
                        <th>Nama Debitur</th>
                        <th>Nomor Identitas Badan Usaha</th>
                        <th>Status Nasabah</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<script>
let debiturTable;
let currentPeriode = "";
let maxslik = "";

// --- INIT DATATABLE ---
function initTable() {
    debiturTable = $('#debiturTable').DataTable({
        serverSide: true,
        processing: true,
        searching: false,
        pageLength: 10,
        scrollX: true,
        language: {
            processing: "Memuat data...",
            emptyTable: "Tidak ada data tersedia untuk periode ini."
        },
        ajax: function (data, callback) {
            const page = Math.floor(data.start / data.length) + 1;
            const page_size = data.length;
            const periodeInput = document.getElementById("periodeFilter").value;
            const periode = periodeInput ? periodeInput.replace("-", "") : "";

            fetch(`/api/data-debitur-aktif?periode=${periode}&page=${page}&page_size=${page_size}`)
                .then(res => res.json())
                .then(result => {
                    if (result.success) {
                        // Jika periode > MAXSLIK â†’ tampilkan kosong
                        if (result.reason === "periode_gt_maxslik") {
                            callback({
                                recordsTotal: 0,
                                recordsFiltered: 0,
                                data: []
                            });
                            $('#btnDownload').prop('disabled', true);
                            return;
                        }

                        callback({
                            recordsTotal: result.total,
                            recordsFiltered: result.total,
                            data: result.data
                        });

                        $('#btnDownload').prop('disabled', result.total === 0);
                    } else {
                        callback({ data: [] });
                        alert("Gagal memuat data: " + (result.message || "Terjadi kesalahan."));
                    }
                })
                .catch(() => {
                    callback({ data: [] });
                    alert("Terjadi kesalahan koneksi ke server.");
                });
        },
        columns: [
            { data: 'PBK_EOD_DATE', title: 'Periode Data', className: 'text-center' },
            { data: 'CUSTOMER_ID', title: 'ID Debitur', className: 'text-center' },
            { data: 'CUST_NAME', title: 'Nama Debitur' },
            { data: 'Nomor_Identitas_Badan_Usaha', title: 'Nomor Identitas Badan Usaha', className: 'text-center' },
            { data: 'CUSTOMER_STATUS', title: 'Status Nasabah', className: 'text-center' }
        ]
    });
}

// --- RELOAD TABLE ---
function reloadTable() {
    const periodeInput = document.getElementById("periodeFilter").value;
    currentPeriode = periodeInput ? periodeInput.replace("-", "") : "";
    debiturTable.ajax.reload();
}

// --- DOWNLOAD EXCEL ---
async function downloadExcel() {
    $('#btnDownload').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Mengunduh...');

    try {
        const response = await fetch('/api/download-data-debitur-aktif', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ periode: currentPeriode })
        });

        const result = await response.clone().json().catch(() => null);

        // Jika periode > MAXSLIK
        if (result && result.success === false) {
            alert(result.message);
            $('#btnDownload').prop('disabled', false).html('<i class="fas fa-file-excel"></i> Download Excel');
            return;
        }

        if (!response.ok) throw new Error("Gagal mengunduh file");

        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `data_debitur_aktif_${currentPeriode || 'all'}.xlsx`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        window.URL.revokeObjectURL(url);

    } catch (err) {
        console.error(err);
        alert("Terjadi kesalahan saat mengunduh file.");
    } finally {
        $('#btnDownload').prop('disabled', false).html('<i class="fas fa-file-excel"></i> Download Excel');
    }
}

// --- INIT PAGE ---
document.addEventListener('DOMContentLoaded', () => {

    // Ambil MAXSLIK untuk default
    fetch('/api/maxslik')
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                maxslik = data.maxslik;
                const formatted = maxslik.slice(0, 4) + "-" + maxslik.slice(4, 6);
                document.getElementById("periodeFilter").value = formatted;
                currentPeriode = maxslik;
            }
            initTable();
        });

    document.getElementById('btnFilter').addEventListener('click', reloadTable);
    document.getElementById('btnDownload').addEventListener('click', downloadExcel);
});
</script>
{% endblock %}
